# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

name: On Pull Request - Dockerfile

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - "src/dms/Dockerfile"
      - "src/config/Dockerfile"
      - ".github/workflows/on-pullrequest-dockerfile.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}

permissions: read-all

jobs:
  docker-analysis:
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        dockerfile:
          [
            { name: "dms", path: "src/dms/Dockerfile" },
            { name: "config", path: "src/config/Dockerfile" }
          ]
    name: Analyze ${{ matrix.dockerfile.name }} Dockerfile
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Hadolint Linter on ${{ matrix.dockerfile.name }} Dockerfile
        uses: hadolint/hadolint-action@54c9adbab1582c2ef04b2016b760714a4bfde3cf # v3.1.0
        with:
          dockerfile: ${{ matrix.dockerfile.path }}
          failure-threshold: error
          # DL3022 warning: `COPY --from` should reference a previously defined `FROM` alias
          # ... this rule does not work well when the "from" is an additional _context_.
          ignore: DL3022

      - name: Log in to Docker Hub
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0

      - name: Build ${{ matrix.dockerfile.name }} image
        run: |
          path=${{ matrix.dockerfile.path }}
          folder=${path%/*}
          cd $folder
          dockerfile=$(echo ${{ matrix.dockerfile.path }} | awk -F"/" '{print $NF}')

          docker buildx build \
            -f $dockerfile \
            -t ${{ matrix.dockerfile.name }}:pr-test \
            --build-context parentdir=../ \
            --load \
            .

      - name: Analyze with Docker Scout
        uses: docker/scout-action@b23590dc1e4d09febc00cfcbc51e9e8c0f7ee9f3 # v1.16.1
        with:
          command: cves
          image: local://${{ matrix.dockerfile.name }}:pr-test
          sarif-file: sarif-${{ matrix.dockerfile.name }}.output.json
          summary: true
          only-severities: "critical,high"

      - name: Upload SARIF result
        id: upload-sarif
        if: ${{ github.event_name != 'pull_request_target' }}
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        with:
          sarif_file: sarif-${{ matrix.dockerfile.name }}.output.json
          category: docker-scout-${{ matrix.dockerfile.name }}

      - name: Upload Scout analysis artifact
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5
        with:
          name: docker-scout-analysis-${{ matrix.dockerfile.name }}
          path: |
            sarif-${{ matrix.dockerfile.name }}.output.json

      - name: Check for Critical and High vulnerabilities
        run: |
          $sarifFile = "sarif-${{ matrix.dockerfile.name }}.output.json"

          if (-not (Test-Path $sarifFile)) {
            Write-Host "⚠️ SARIF file not found: $sarifFile"
            exit 0
          }

          $sarifContent = Get-Content -Path $sarifFile -Raw | ConvertFrom-Json
          $criticalHighVulnerabilities = 0

          foreach ($run in $sarifContent.runs) {
            foreach ($result in $run.results) {
              # Extract severity from the message text
              if ($result.message.text -match "Severity\s+:\s+(\w+)") {
                $severity = $matches[1].Trim()

                if ($severity -ieq "critical") { # For now the check only fails for critical Vulnerabilities (disble the  -or $severity -ieq "high" validation)
                  $criticalHighVulnerabilities++
                  Write-Host "❌ Found $severity vulnerability: $($result.ruleId)"

                  if ($result.message.text) {
                    # Extract package info if available
                    if ($result.message.text -match "Package\s+:\s+([^\n]+)") {
                      Write-Host "   Package: $($matches[1].Trim())"
                    }
                  }
                }
              }
            }
          }

          Write-Host "`n========================================="
          Write-Host "DOCKER SCOUT PR ANALYSIS - ${{ matrix.dockerfile.name }}"
          Write-Host "========================================="
          Write-Host "Critical vulnerabilities: $criticalHighVulnerabilities"
          Write-Host "=========================================`n"

          if ($criticalHighVulnerabilities -gt 0) {
            Write-Error "❌ Found $criticalHighVulnerabilities critical vulnerabilities in ${{ matrix.dockerfile.name }}."
            Write-Host "Please review the Security tab for details and remediate before merging."
            exit 1
          } else {
            Write-Host "✅ No critical vulnerabilities found in ${{ matrix.dockerfile.name }}."
          }
        shell: pwsh
