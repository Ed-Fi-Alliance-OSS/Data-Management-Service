# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

name: Analyze Docker Images

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight UTC
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}

jobs:
  analyze-docker:
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        dockerfile:
          [
            { name: "edfialliance/data-management-service", path: "src/dms", dockerfile: "Dockerfile" },
            { name: "edfialliance/dms-configuration-service", path: "src/config", dockerfile: "Dockerfile" }
          ]
    name: Analyze ${{ matrix.dockerfile.name }}
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Log in to Docker Hub
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0

      - name: Get version for image tag
        id: versions
        run: |
          # Use MinVer or fallback to date-based version
          if command -v dotnet &> /dev/null; then
            cd ${{ matrix.dockerfile.path }}
            version=$(dotnet minver -v e 2>/dev/null || echo "0.0.0")
            echo "VERSION=$version" >> $GITHUB_OUTPUT
          else
            # Fallback: use date-based version
            version="0.0.$(date +%Y%m%d)"
            echo "VERSION=$version" >> $GITHUB_OUTPUT
          fi
          echo "Detected version: $version"
        shell: bash

      - name: Build ${{ matrix.dockerfile.name }} image
        run: |
          cd ${{ matrix.dockerfile.path }}
          docker buildx build \
            -f ${{ matrix.dockerfile.dockerfile }} \
            -t ${{ matrix.dockerfile.name }}:${{ steps.versions.outputs.VERSION }} \
            -t ${{ matrix.dockerfile.name }}:latest \
            --build-context parentdir=../  \
            --load \
            .

          echo "IMAGENAME=${{ matrix.dockerfile.name }}:${{ steps.versions.outputs.VERSION }}" >> $GITHUB_ENV
        shell: bash

      - name: Generate SBOM with Docker Scout (SPDX format)
        uses: docker/scout-action@b23590dc1e4d09febc00cfcbc51e9e8c0f7ee9f3 # v1.16.1
        with:
          command: sbom
          image: ${{ env.IMAGENAME }}
          format: spdx
          output: sbom-${{ matrix.dockerfile.name }}-${{ steps.versions.outputs.VERSION }}.spdx.json

      - name: Analyze for CVEs
        uses: docker/scout-action@b23590dc1e4d09febc00cfcbc51e9e8c0f7ee9f3 # v1.16.1
        with:
          command: cves
          image: ${{ env.IMAGENAME }}
          sarif-file: sarif-${{ matrix.dockerfile.name }}-${{ steps.versions.outputs.VERSION }}.output.json
          summary: true
          only-severities: "critical"

      - name: Set artifact name
        id: set-artifact-name
        run: |
          # Replace slashes with hyphens for artifact naming
          artifactName="${{ matrix.dockerfile.name }}"
          artifactName="${artifactName//\//-}"
          echo "ARTIFACT_NAME=vulnerabilities-$artifactName-${{ steps.versions.outputs.VERSION }}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload ${{ steps.set-artifact-name.outputs.ARTIFACT_NAME }} Report
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5
        with:
          name: ${{ steps.set-artifact-name.outputs.ARTIFACT_NAME }}
          path: |
            sarif-${{ matrix.dockerfile.name }}-${{ steps.versions.outputs.VERSION }}.output.json
            sbom-${{ matrix.dockerfile.name }}-${{ steps.versions.outputs.VERSION }}.spdx.json

      - name: Upload SARIF result
        id: upload-sarif
        if: ${{ github.event_name != 'pull_request_target' }}
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
        with:
          sarif_file: sarif-${{ matrix.dockerfile.name }}-${{ steps.versions.outputs.VERSION }}.output.json

      - name: Check for Critical and High vulnerabilities
        run: |
          $sarifFile = "sarif-${{ matrix.dockerfile.name }}-${{ steps.versions.outputs.VERSION }}.output.json"

          if (-not (Test-Path $sarifFile)) {
            Write-Host "SARIF file not found: $sarifFile"
            exit 0
          }

          $sarifContent = Get-Content -Path $sarifFile -Raw | ConvertFrom-Json
          $criticalVulnerabilities = 0
          $highVulnerabilities = 0

          foreach ($run in $sarifContent.runs) {
            foreach ($result in $run.results) {
              # Extract severity from the message text
              if ($result.message.text -match "Severity\s+:\s+(\w+)") {
                $severity = $matches[1].Trim()

                if ($severity -ieq "critical") {
                  $criticalVulnerabilities++
                  Write-Host "❌ Found $severity vulnerability: $($result.ruleId)"

                  if ($result.message.text) {
                    # Extract package info if available
                    if ($result.message.text -match "Package\s+:\s+([^\n]+)") {
                      Write-Host "   Package: $($matches[1].Trim())"
                    }
                  }
                }
                if ($severity -ieq "high") {
                  $highVulnerabilities++
                  Write-Host "❌ Found $severity vulnerability: $($result.ruleId)"

                  if ($result.message.text) {
                    # Extract package info if available
                    if ($result.message.text -match "Package\s+:\s+([^\n]+)") {
                      Write-Host "   Package: $($matches[1].Trim())"
                    }
                  }
                }
              }
            }
          }

          if ($criticalVulnerabilities -gt 0) {
            Write-Error "Found $criticalVulnerabilities critical vulnerabilities in ${{ matrix.dockerfile.name }}."
            exit 1
          } else {
            Write-Host "✅ No critical vulnerabilities found in ${{ matrix.dockerfile.name }}."
          }
        shell: pwsh

  finalize:
    needs: analyze-docker
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download all vulnerability reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: ./vulnerability-reports

      - name: Determine if there were critical or high vulnerabilities
        run: |
          Write-Host "Analyzing all vulnerability reports..."

          # Get all SARIF files in the directory
          $files = Get-ChildItem -Path ./vulnerability-reports -Recurse -File -Filter "*.json"

          if ($files.Count -eq 0) {
            Write-Host "⚠️ No vulnerability reports found."
            exit 0
          }

          $criticalHighVulnerabilities = 0
          $vulnerabilityDetails = @()

          foreach ($file in $files) {
            Write-Host "`nProcessing file: $($file.FullName)"

            try {
              $sarifData = Get-Content $file.FullName -Raw | ConvertFrom-Json

              foreach ($run in $sarifData.runs) {
                $toolName = if ($run.tool.driver.name) { $run.tool.driver.name } else { "Unknown" }

                foreach ($result in $run.results) {
                  # Extract severity from the message text
                  if ($result.message.text -match "Severity\s+:\s+(\w+)") {
                    $severity = $matches[1].Trim()

                    if ($severity -ieq "critical" -or $severity -ieq "high") {
                      $criticalHighVulnerabilities++

                      $vulnInfo = @{
                        File = $file.Name
                        Severity = $severity
                        RuleId = $result.ruleId
                        Message = $result.message.text
                      }
                      $vulnerabilityDetails += $vulnInfo

                      Write-Host "  ❌ Found $severity vulnerability: $($result.ruleId) in $($file.Name)"
                    }
                  }
                }
              }
            }
            catch {
              Write-Host "  ⚠️ Error processing file: $_"
            }
          }

          Write-Host "`n========================================="
          Write-Host "VULNERABILITY SUMMARY"
          Write-Host "========================================="
          Write-Host "Total files analyzed: $($files.Count)"
          Write-Host "Critical/High vulnerabilities found: $criticalHighVulnerabilities"
          Write-Host "=========================================`n"

          if ($criticalHighVulnerabilities -gt 0) {
            Write-Host "❌ DETAILED VULNERABILITY REPORT:"
            Write-Host "---------------------------------"

            foreach ($vuln in $vulnerabilityDetails) {
              Write-Host "`nFile: $($vuln.File)"
              Write-Host "Severity: $($vuln.Severity)"
              Write-Host "Rule ID: $($vuln.RuleId)"
              Write-Host "Message: $($vuln.Message.Substring(0, [Math]::Min(200, $vuln.Message.Length)))..."
            }

            Write-Error "`n❌ FAILURE: Found $criticalHighVulnerabilities critical or high vulnerabilities across all Docker images."
            exit 1
          } else {
            Write-Host "✅ SUCCESS: No critical or high vulnerabilities found in any Docker images."
          }
        shell: pwsh
