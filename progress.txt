2026-02-13
- Completed: tasks.json#0 Algorithm subsection under "Integration Point + Pass Ordering" (DMS-1033)
- Decisions: single ordered list; explicitly lists fail-fast + pass mutations (Columns/Constraints/KeyUnificationClasses/eq-constraint diagnostics); inlines canonical+presence naming + hash formulas; explicit non-goals (no FK rewrite; FK derivation later in ReferenceConstraintPass)
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Notes: follow-up tasks likely: #4 FK responsibility/allowIdentityUpdates/ON DELETE wording; #3 make ref-membership detection rule normative for presence gating (SourceJsonPath lookup vs current "identity binding" wording)
- Completed: tasks.json#3 Presence Gating (design doc)
- Decisions: presence gating uses authoritative lookup (member SourceJsonPath == DocumentReferenceBinding.IdentityBindings[*].ReferenceJsonPath); gate by binding FkColumn when found; non-reference optional uses synthetic ..._Present; non-reference required is ungated; fail fast on ambiguous multiple bindings; avoid name parsing heuristics
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#2 Schema Exceptions (DMS-1033)
- Decisions: ApiSchema `equalityConstraints` authoritative; legacy ODS physical-schema differences are non-authoritative; no v1 suppression/override; canonical always new column + members become `UnifiedAlias` (presence-gated when optional)
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Notes: if an equality constraint appears incorrect, fix upstream (ApiSchema generation / effective schema inputs); diagnostics remain `applied`/`redundant`/`ignored`
- Completed: tasks.json#9 Defaults (design doc)
- Decisions: ColumnStorage init default = `Stored` for all pre-existing columns; KeyUnificationPass only pass that sets `UnifiedAlias`; canonical + synthetic presence columns always `Stored`; old artifacts missing storage metadata rejected via `RelationalMappingVersion` mismatch (back-compat only via explicit older-version mode)
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#4 Foreign Keys (DMS-1033)
- Decisions: KeyUnificationPass mutates columns/classes only (no FK emission); ReferenceConstraintPass emits composite ref FKs by mapping binding→storage via `DbColumnModel.Storage`; referential actions unchanged (ON UPDATE allowIdentityUpdates-gated + existing SQL Server fallback; ON DELETE NO ACTION)
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#1 Dialect Hashing (DMS-1033)
- Decisions: NullOrTrue constraint signature = (kind="NullOrTrue", table=(schema,name), column=PresenceColumnName); explicitly participates in ApplyConstraintDialectHashingPass + ApplyDialectIdentifierShorteningPass; shortening updates Name + Column references
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#7 Ordering (DMS-1033)
- Decisions: KeyUnificationPass not required to establish final `DbTableModel.Columns` order; CanonicalizeOrderingPass (or later reorder) must restore alias dependency invariant using `DbColumnModel.Storage` (CanonicalColumn/PresenceColumn before alias); restate recommended per-table ordering (key, support cols, remaining)
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Notes: implementation note: current canonical ordering needs to account for alias dependencies (avoid name-sort breaking canonical-before-alias)
- Completed: tasks.json#5 Diagnostics (design doc)
- Decisions: emit deterministic `descriptor_fk_deduplications[]` per-table manifest entries when descriptor FK constraints are de-duplicated (storage_column + binding_columns + final constraint_name); deterministic ordering; explicitly separate from equality-constraint applied/redundant/ignored report
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#8 Constraints (design doc)
- Decisions: All-or-none CHECK constraints reference per-site binding columns even when they are persisted/stored `UnifiedAlias` computed/generated cols; valid in SQL Server + PostgreSQL; no workaround
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#2 Examples (design doc) (DMS-1033)
- Decisions: worked example for optional non-reference scalar unification w/ synthetic `..._Present` flags; shows canonical stored col + two presence gates + two unified aliases; includes SQL Server + PostgreSQL DDL; enumerates coalescing scenarios + “absent path stays absent” semantics
- Files: reference/design/backend-redesign/design-docs/key-unification.md; tasks.json; progress.txt
- Completed: tasks.json#15 Docs: Flattening + Reconstitution (DMS-1033)
- Decisions: add `DbColumnModel.Storage` + `DbTableModel.KeyUnificationClasses`; add `WriteValueSource.Precomputed` + `KeyUnificationWritePlan`; plan compiler excludes `UnifiedAlias` from writes; flattener two-phase materialization w/ deterministic coalescing + conflict detection + synthetic presence flags (absent=NULL, present=TRUE)
- Files: reference/design/backend-redesign/design-docs/flattening-reconstitution.md; tasks.json; progress.txt
- Completed: tasks.json#17 Docs: Mapping Pack Format (DMS-1033)
- Decisions: add `DbColumnModel.storage` (Stored vs UnifiedAlias canonical+presence); add `DbTableModel.key_unification_classes`; add `WriteValueSource.Precomputed` + `TableWritePlan.key_unification_plans`; determinism rules for new repeated fields; key-unification gating via `RelationalMappingVersion` (reject older packs missing metadata unless explicitly in older mode)
- Files: reference/design/backend-redesign/design-docs/mpack-format-v1.md; tasks.json; progress.txt
- Notes: proto uses `optional uint32 presence_binding_index`; ensure contracts generator/protoc version supports proto3 optional
- Completed: tasks.json#12 Docs: Data Model (DMS-1033)
- Decisions: bind vs store clarified; NK uniques are API/binding-path columns; RefKey uniques + composite ref FKs use storage columns (canonical via `DbColumnModel.Storage`); all-or-none CHECK remains over per-site binding/alias cols; name docs now mention `_Unified` canonical + `_Present` synthetic flags (delegated to key-unification.md); examples updated to show NK vs RefKey + composite FKs
- Files: reference/design/backend-redesign/design-docs/data-model.md; tasks.json; progress.txt
- Completed: tasks.json#13 Docs: DDL Generation (DMS-1033)
- Decisions: replace outdated key unification note; canonical stored cols + persisted/stored generated aliases; presence gating uses `..._DocumentId` or synthetic `..._Present`; composite ref FKs + descriptor FKs anchored on storage cols via `DbColumnModel.Storage`; descriptor FK de-dup by (table, storage col); no DB CHECK colA=colB for writable cols; cross-ref key-unification.md for dialect DDL
- Files: reference/design/backend-redesign/design-docs/ddl-generation.md; tasks.json; progress.txt
- Completed: tasks.json#14 Docs: Transactions + Concurrency (DMS-1033)
- Decisions: binding/path vs canonical/storage explicitly called out; cascades + SQL Server trigger-based fallback update canonical/storage cols (never aliases); writers set canonical cols + synthetic presence flags deterministically (no keep previous)
- Files: reference/design/backend-redesign/design-docs/transactions-and-concurrency.md; tasks.json; progress.txt
- Notes: remaining doc tasks: #10 #11 #16 #18 #19
- Completed: tasks.json#16 Docs: Compiled Mapping Set (DMS-1033)
- Decisions: write path clarifies `ColumnBindings` excludes `UnifiedAlias`; canonical + synthetic `..._Present` cols are `WriteValueSource.Precomputed` via `KeyUnificationWritePlan`; read/query binds by per-path columns incl `UnifiedAlias`; call out composite-FK storage mapping + descriptor-FK de-dup diagnostics
- Files: reference/design/backend-redesign/design-docs/compiled-mapping-set.md; tasks.json; progress.txt
- Notes: remaining doc tasks: #10 #11 #18 #19
- Completed: tasks.json#18 Docs: Manifests + Test Harness (DMS-1033)
- Decisions: manifest surfaces must include key-unification metadata + diagnostics (per-column `storage`; per-table `key_unification_classes` + `descriptor_fk_deduplications`; per-resource applied/redundant/ignored equality report); pack/mappingset semantic manifests include same; add small fixtures for reference-site unification + optional scalar synthetic `..._Present`
- Files: reference/design/backend-redesign/design-docs/ddl-generator-testing.md; tasks.json; progress.txt
- Notes: remaining doc tasks: #10 #11 #19
- Completed: tasks.json#10 Docs: Overview + Summary (DMS-1033)
- Decisions: add key-unification to doc lists; clarify binding vs storage (per-site/per-path bindings may be generated/persisted aliases; canonical stored cols are write/FK/cascade targets); explicitly call out presence-gated aliases keep absent optional ref/path as `NULL` at binding even when canonical is non-null
- Files: reference/design/backend-redesign/design-docs/overview.md; reference/design/backend-redesign/design-docs/summary.md; tasks.json; progress.txt
- Notes: remaining doc tasks: #11 #19
- Completed: tasks.json#19 Docs: Terminology Sweep (DMS-1033)
- Decisions: replace "propagated identity columns" wording w/ canonical storage + per-site binding terminology; clarify cascades target canonical/storage cols and binding cols may be generated aliases; cross-ref `key-unification.md`
- Files: reference/design/backend-redesign/design-docs/update-tracking.md; reference/design/backend-redesign/design-docs/etl-view-sketch.md; reference/design/backend-redesign/design-docs/transactions-and-concurrency.md; tasks.json; progress.txt
- Notes: remaining doc tasks: #11
- Completed: tasks.json#11 Docs: Strengths + Risks (DMS-1033)
- Decisions: add key-unification strength (canonical single source of truth + generated/persisted aliases); SQL Server cascade-path risk calls out key-unification multi-edge cascades via shared canonical cols across multiple composite FKs; add key-unification complexity risk (generated aliases + synthetic `..._Present` flags: DDL/indexing/write planning/diagnostics); update doc terminology to binding vs canonical
- Files: reference/design/backend-redesign/design-docs/strengths-risks.md; tasks.json; progress.txt
2026-02-14
- Completed: tasks.json#0 Contracts (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: `DbTriggerInfo.Table` -> `TriggerTable`; `TargetTable` -> `MaintenanceTargetTable`; add typed `PropagationFallback` payload (`ReferrerTable`, `ReferrerDocumentIdColumn`, `ReferencedDocumentIdColumn`, ordered `(ReferrerStorageColumn, ReferencedStorageColumn)` pairs); keep `KeyColumns` + `IdentityProjectionColumns` for non-fallback kinds; XML docs now state `IdentityProjectionColumns` are null-safe value-diff compare inputs (not `UPDATE(column)` gates)
- Files: src/dms/backend/EdFi.DataManagementService.Backend.External/DerivedRelationalModelSetContracts.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ApplyDialectIdentifierShorteningPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelSetBuilderContext.cs; src/dms/backend/EdFi.DataManagementService.Backend.Ddl/RelationalModelDdlEmitter.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DerivedRelationalModelSetAuthoritativeGoldenTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DerivedRelationalModelSetBuilderOrderingTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DialectIdentifierShorteningTests.cs; tasks.json; progress.txt
- Notes: next iteration likely #1 Trigger Inventory (root identity-projection set correctness for identity-component refs) and #2 Propagation Fallback strategy shift (trigger fires on referenced table, fan-out referrers) now unblocked by payload contract
- Completed: tasks.json#1 Trigger Inventory (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: root `IdentityProjectionColumns` now resolve identity-component refs to ordered `IdentityBindings[*].Column` values (value-diff inputs), not stable `..._DocumentId`; keep root-table/scalar path behavior; fail-fast if an identity path maps to non-root/non-identity/no-identity-bindings ref
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/sample/expected/authoritative-derived-relational-model-set.json; tasks.json; progress.txt
- Notes: next iteration likely #2 Propagation Fallback (emit one trigger per referenced table with fan-out actions)
- Completed: tasks.json#2 Propagation Fallback (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: MSSQL fallback now one trigger per referenced table (`TriggerTable` = referenced root/abstract identity table) with fan-out `ReferrerActions`; includes root + non-root reference sites (child/collection/extension) via path-aware binding-table resolution; eligibility unchanged (abstract targets or concrete `allowIdentityUpdates=true` only); action list + pair lists are deterministic and de-duplicated; PostgreSQL still emits none
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs; tasks.json; progress.txt
- Notes: next likely task #3 Identifier Shortening to validate/lock shortening over new one-trigger-per-target payload shape
- Completed: tasks.json#3 Identifier Shortening (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: keep existing DocumentStamping trigger assertions by selecting trigger kind; extend shortening fixture with IdentityPropagationFallback trigger + payload; assert shortening covers TriggerTable + propagation ReferrerTable/DocumentId cols/identity storage-column pairs for Pgsql+Mssql; trigger-scope collision behavior remains covered by invariant tests using `TriggerTable`
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DialectIdentifierShorteningTests.cs; tasks.json; progress.txt
- Notes: next likely task #4 DDL Emission
- Completed: tasks.json#4 DDL Emission (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: DDL trigger owner always from `DbTriggerInfo.TriggerTable`; for MSSQL emit schema-qualified trigger identifiers (`[TriggerTable.Schema].[TriggerName]`) to match schema-scoped trigger namespace and avoid default-schema drift; keep propagation body placeholder unchanged (`AS BEGIN END;` / `EXECUTE FUNCTION noop();`)
- Files: src/dms/backend/EdFi.DataManagementService.Backend.Ddl/RelationalModelDdlEmitter.cs; src/dms/backend/EdFi.DataManagementService.Backend.Ddl.Tests.Unit/RelationalModelDdlEmitterTests.cs; tasks.json; progress.txt
- Notes: next likely task #5 Index Inventory (storage-column FK/index invariants for key-unification)
- Completed: tasks.json#5 Index Inventory (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: DeriveIndexInventoryPass now fail-fast validates FK columns pre-indexing; rejects unknown columns + synthetic `..._Present`; rejects alias/binding FK columns when sibling canonical `..._Unified` exists; keep leftmost-prefix suppression unchanged so converged storage-key FK sets emit one deterministic support index
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveIndexInventoryPassTests.cs; tasks.json; progress.txt
- Notes: alias detection is currently naming-based (`<column>_Unified` sibling) until typed storage metadata lands; next likely task #6 Docs (or #7 Query Planning)
- Completed: tasks.json#6 Docs (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: lock docs to implemented trigger/index semantics: SQL Server reference FKs always `ON UPDATE NO ACTION`; eligible identity propagation via `DbTriggerKind.IdentityPropagationFallback` as one trigger per referenced table (`TriggerTable`) with deterministic referrer fan-out updating canonical/storage only; clarify `IdentityProjectionColumns` = null-safe value-diff compare set (not `UPDATE(column)` gates); update pass naming to `DeriveIndexInventoryPass` + `DeriveTriggerInventoryPass`; remove filtered/partial index modeling suggestion from key-unification workstream
- Files: reference/design/backend-redesign/design-docs/key-unification.md; reference/design/backend-redesign/design-docs/transactions-and-concurrency.md; reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md; tasks.json; progress.txt
- Notes: remaining task #7 Query Planning; current repo has no active relational query compiler path in new backend projects (likely needs a design/implementation spike before unified-alias predicate rewrite work)
- Completed: tasks.json#7 Query Planning (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: replace `Backend.Plans` placeholder with concrete page-DocumentId SQL compiler; enforce unified-alias predicate rewrite via explicit alias mapping (`AliasColumn -> CanonicalColumn + optional PresenceColumn`); gated alias rewrites to `PresenceColumn IS NOT NULL AND CanonicalColumn <op> @p`; ungated alias rewrites to canonical-only predicate; keep non-unified predicates on bound columns
- Files: src/dms/backend/EdFi.DataManagementService.Backend.Plans/QueryComparisonOperator.cs; src/dms/backend/EdFi.DataManagementService.Backend.Plans/PageDocumentIdQueryModels.cs; src/dms/backend/EdFi.DataManagementService.Backend.Plans/PageDocumentIdSqlCompiler.cs; src/dms/backend/EdFi.DataManagementService.Backend.Plans/Placeholder.cs; src/dms/backend/EdFi.DataManagementService.Backend.Tests.Unit/EdFi.DataManagementService.Backend.Tests.Unit.csproj; src/dms/backend/EdFi.DataManagementService.Backend.Tests.Unit/Given_PageDocumentIdSqlCompiler.cs; tasks.json; progress.txt
- Notes: current relational contracts do not expose `DbColumnModel.Storage`; compiler takes explicit mapping now and can be wired to typed storage metadata when key-unification contracts land
- Completed: tasks.json#8 Key Unification (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: add typed `ColumnStorage` contract (`Stored` + `UnifiedAlias`) as defaulted metadata on `DbColumnModel` to avoid constructor churn and preserve backward behavior; add default-empty `DbTableModel.KeyUnificationClasses`; emit `storage` + `key_unification_classes` in manifests now so consumers/goldens lock deterministic shape before `KeyUnificationPass` lands
- Files: src/dms/backend/EdFi.DataManagementService.Backend.External/RelationalModelTypes.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelManifestEmitter.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelManifestEmitterTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DerivedRelationalModelSetBuilderTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DerivedRelationalModelSetAuthoritativeGoldenTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/ds-5.2/expected/authoritative-relational-model.manifest.json; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/ds-5.2/expected/authoritative-relational-model.derived.manifest.json; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/sample/expected/authoritative-derived-relational-model-set.json; tasks.json; progress.txt
- Notes: no `UnifiedAlias` producers yet; follow-up task #9 should wire `KeyUnificationPass` + validation of canonical/presence references
- Completed: tasks.json#9 Key Unification (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: add new `KeyUnificationPass` that parses `resourceSchema.equalityConstraints`, resolves endpoints by `SourceJsonPath`, builds same-table connected components, creates one canonical stored column per class, rewrites member path columns to `Storage = UnifiedAlias(canonical, presence)`; reference members gate via bound `..._DocumentId`; optional non-reference members get synthetic nullable boolean `..._Present` flags; deterministic class/member/name ordering + collision disambiguation via hash fallback
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/KeyUnificationPassTests.cs; tasks.json; progress.txt
- Notes: covered with dedicated unit fixtures for reference-site and optional-scalar unification; downstream FK/index/trigger storage-column rewrites remain in remaining tasks (#10-#12)
- Completed: tasks.json#11 Constraints (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: ReferenceConstraintPass now maps FK local/target identity columns through `DbColumnModel.Storage` and de-dups after storage mapping by ordered storage-column pairs; keeps all-or-none checks on per-site binding aliases; rejects synthetic scalar presence flags in FK derivation while allowing reference `..._DocumentId` presence gates
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceConstraintPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs; tasks.json; progress.txt
- Notes: Added key-unification constraints fixture asserting FK + target RefKey unique collapse to canonical storage column once; next likely task #12 Index Inventory storage-metadata validation (replace suffix heuristics)
- Completed: tasks.json#13 Trigger Inventory (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: DeriveTriggerInventoryPass now resolves propagation identity pairs through `DbColumnModel.Storage` on referrer + referenced tables; rejects missing/synthetic/non-stored canonical mappings; pair de-dup remains deterministic first-seen but now occurs after storage mapping so unified aliases collapse to one canonical pair
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; tasks.json; progress.txt
- Notes: added MSSQL key-unification fixture asserting propagation payload emits one canonical stored pair when multiple binding endpoints unify
- Completed: tasks.json#11 Index Inventory (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: replace suffix heuristics in DeriveIndexInventoryPass with storage metadata (`DbColumnModel.Storage`) + metadata-derived synthetic presence set (only scalar synthetic flags; do not treat reference `..._DocumentId` gates as synthetic presence); fail fast on FK alias/presence columns, allow stored columns even when names end with `_Unified`/`_Present`
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveIndexInventoryPassTests.cs; tasks.json; progress.txt
- Notes: added fixtures for custom canonical names (non-`_Unified`), metadata presence-column rejection, and stored suffix-name non-false-positive behavior; remaining open tasks: #13 #14 #15 #16 #17
- Completed: tasks.json#17 Trigger DDL (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: RelationalModelDdlEmitter now resolves `IdentityProjectionColumns` through `DbColumnModel.Storage`; value-diff gating is null-safe for both dialects; `UnifiedAlias(Canonical, Presence)` compares presence-gated canonical expressions (`CASE WHEN Presence IS NULL THEN NULL ELSE Canonical END`) and never alias columns; propagation fallback trigger body remains placeholder (no identity compare set)
- Files: src/dms/backend/EdFi.DataManagementService.Backend.Ddl/RelationalModelDdlEmitter.cs; src/dms/backend/EdFi.DataManagementService.Backend.Ddl.Tests.Unit/RelationalModelDdlEmitterTests.cs; tasks.json; progress.txt
- Notes: added DDL tests for both dialects + dedicated presence-gated unified-alias fixture; relational trigger fixture now includes identity projection columns so storage-aware expression resolution is validated
- Completed: tasks.json#15 Refactor (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: centralized deepest-prefix table-scope selection + `_ext` scope validation into shared `ReferenceObjectPathScopeResolver`; `ReferenceBindingPass` + `DeriveTriggerInventoryPass` now call same helper; trigger-path resolution now also fail-fast on same-depth ambiguous matches instead of implicit first-match
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceObjectPathScopeResolver.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceBindingPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; tasks.json; progress.txt
- Notes: remaining open tasks #13 Naming, #14 Trigger Inventory ordering, #16 Refactor typed identity-pair de-dup key
- Completed: tasks.json#14 Trigger Inventory ordering (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: root `IdentityProjectionColumns` now iterate `identityJsonPaths` and resolve only exact matching `IdentityBindings` per path; no longer add all columns for first matching reference; retain de-dup first-seen semantics; fail-fast when a reference identity path has no local identity-part column mapping
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/sample/expected/authoritative-derived-relational-model-set.json; tasks.json; progress.txt
- Notes: remaining open tasks are #13 Naming (`PropagateIdentity` token) and #16 Refactor (typed identity-column-pair de-dup key)
- Completed: tasks.json#16 Refactor (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: replace delimiter-signature pair de-dup in `AddIdentityColumnPair(...)` with typed key `HashSet<(DbColumnName ReferrerStorageColumn, DbColumnName ReferencedStorageColumn)>`; preserve first-seen ordering by keeping append flow unchanged
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; tasks.json; progress.txt
- Notes: remaining open task is #13 Naming (`PropagateIdentity` trigger token)
- Completed: tasks.json#13 Naming (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: rename propagation fallback purpose token to `PropagateIdentity` in derivation (`TR_{Table}_PropagateIdentity`); align DDL expectations + trigger inventory tests to same durable token from data-model docs; no logic/ordering changes beyond naming
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.Ddl.Tests.Unit/RelationalModelDdlEmitterTests.cs; tasks.json; progress.txt
- Notes: task list now fully complete for this story slice
- Completed: tasks.json#18 Key Unification (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: inserted `KeyUnificationPass` into default pass order after `ReferenceBindingPass`; switched key-unification fixtures to run via `RelationalModelSetPasses.CreateDefault()`; added deterministic endpoint-resolution fallbacks for legacy equality endpoint forms (`...gradingPeriodSchoolId`) + ambiguous duplicate reference-path endpoints; rewrote pre-existing local FK constraints to canonical storage columns during key-unification so downstream FK/index validation operates on storage metadata only
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelSetPasses.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelSetPassesTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/KeyUnificationPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/ds-5.2/expected/authoritative-relational-model.derived.manifest.json; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/sample/expected/authoritative-derived-relational-model-set.json; tasks.json; progress.txt
- Notes: feedback loops green (`dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`; relational-model unit tests). Remaining open tasks: #19 #20 #21 #22 #23
- Completed: tasks.json#19 Trigger Inventory (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: propagation fallback now hard-fails when `DocumentReferenceMapping.ReferenceObjectPath` has no derived `DocumentReferenceBinding`; removed silent skip to prevent dropped referrer actions; exception includes mapping key + formatted resource + exact reference object path
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveTriggerInventoryPassTests.cs; tasks.json; progress.txt
- Notes: added synthetic mismatch fixture pass to inject unmapped mapping just before trigger derivation; feedback loops green (`dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`; `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`); remaining open tasks: #20 #21 #22 #23
- Completed: tasks.json#20 Refactor (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: disambiguated presence-column semantics across passes: index pass now uses `BuildSyntheticPresenceFlagSet(...)` (synthetic optional-path flags only), trigger pass uses `BuildPresenceGateColumnSet(...)` (all `UnifiedAlias.PresenceColumn` gates incl reference `..._DocumentId`); updated trigger storage-resolution errors to say "presence-gate column" (not "synthetic") so diagnostics match actual rejected column type
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; tasks.json; progress.txt
- Notes: feedback loops green (`dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`; `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`); remaining open tasks: #21 #22 #23
- Completed: tasks.json#21 Index Inventory (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: synthetic presence-flag classification now metadata-based only (`ColumnKind.Scalar` + nullable + `SourceJsonPath=null` + `Storage=Stored` + boolean scalar type); if a `UnifiedAlias.PresenceColumn` points at a scalar null-source nullable non-boolean/non-stored candidate, fail fast with clear invariant error; reference-site presence gates (`..._DocumentId`) remain excluded from synthetic set
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DeriveIndexInventoryPassTests.cs; tasks.json; progress.txt
- Notes: added non-boolean synthetic-presence edge-case fixture/test; feedback loops green (`dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`; `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`); remaining open tasks: #22 #23
- Completed: tasks.json#23 Refactor (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: moved table-scope mismatch exception construction into `ReferenceObjectPathScopeResolver.ResolveOwningTableScope(...)`; both `ReferenceBindingPass` and `DeriveTriggerInventoryPass` now call shared helper; candidate scope lists now included consistently for no-match/ambiguous/extension-scope failures; preserved explicit fail-fast when trigger derivation binding table name has zero candidates
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceObjectPathScopeResolver.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceBindingPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; tasks.json; progress.txt
- Notes: feedback loops green (`dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`; `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`); remaining open task: #22
- Completed: tasks.json#22 Refactor (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: remove duplicate per-table `ToDictionary(...)` allocation in `DeriveIndexInventoryPass` by threading existing `columnsByName` lookup into `BuildSyntheticPresenceFlagSet(...)`; preserve synthetic presence classification + FK validation behavior
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs; tasks.json; progress.txt
- Notes: feedback loops green (`dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`; `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`); task list complete
2026-02-15
- Completed: tasks.json#26 Refactor (DMS-945 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: introduced shared `UnifiedAliasStorageResolver` for table metadata + alias->canonical storage resolution + presence-gate classification; explicit caller policies preserve per-pass intent (`RejectSyntheticScalarPresence` for FK derivation vs `RejectAllPresenceGates` for trigger propagation; strict synthetic-flag classification for index validation vs any-scalar classification for FK mapping)
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/UnifiedAliasStorageResolver.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveTriggerInventoryPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceConstraintPass.cs; tasks.json; progress.txt
- Notes: feedback loops green (`dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`; `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`); remaining open tasks: #24 #25 #27 #28
- Completed: tasks.json#25 Constraints (DMS-1033 / reference/design/backend-redesign/epics/01-relational-model/07-index-and-trigger-inventory.md)
- Decisions: added set-level FK invariant pass `ValidateForeignKeyStorageInvariantPass` to validate both local `Columns` and target `TargetColumns` are direct stored columns and not synthetic scalar presence flags; fail-fast diagnostics include FK name + referencing/referenced table + offending columns; treat `dms.Document` as a known system target and validate its target columns are `DocumentId` only
- Files: src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ValidateForeignKeyStorageInvariantPass.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelSetPasses.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs; src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelSetPassesTests.cs; tasks.json; progress.txt
- Notes: feedback loops green (`dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`; `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`); remaining open tasks: #26 #28 #29
