# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    serviceName: dms-opensearch
  name: dms-opensearch
spec:
  replicas: 1
  selector:
    matchLabels:
      serviceName: dms-opensearch
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        serviceName: dms-opensearch
    spec:
      containers:
      - name: dms-opensearch
        image: opensearchproject/opensearch:2.15.0@sha256:1a6d62f4ff2215f66792362a56c64cea29ff6cbe700f95881857f045a6fea3c9
        ports:
        - containerPort: 9000

        env:
        - name: "OPENSEARCH_INITIAL_ADMIN_PASSWORD"
          value: ""

        - name: "OPENSEARCH_ADMIN_PASSWORD"
          value: "123"

        - name: "cluster.name"
          value: "opensearch-cluster"

        # along with the memlock settings below, disables swapping
        - name: "bootstrap.memory_lock"
          value: "true"

        # minimum and maximum Java heap size, recommend setting both to 50% of system RAM
        - name: "OPENSEARCH_JAVA_OPTS"
          value: "-Xms512m -Xmx512m"

        - name: "discovery.type"
          value: "single-node"

        # DISABLING TLS SECURITY:
        # disables execution of install_demo_configuration.sh bundled with security plugin, which installs demo certificates and security configurations to OpenSearch
        - name: "DISABLE_INSTALL_DEMO_CONFIG"
          value: "true"

        # disables security plugin entirely in OpenSearch by setting plugins.security.disabled: true in opensearch.yml
        - name: "DISABLE_SECURITY_PLUGIN"
          value: "true"

      restartPolicy: Always
status: {}
