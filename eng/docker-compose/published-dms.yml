# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

services:
  dms:
    image: edfialliance/data-management-service:${DMS_IMAGE_TAG:-pre}
    environment:
      ASPNETCORE_HTTP_PORTS: ${DMS_HTTP_PORTS:-8080}
      AppSettings__AuthenticationService: ${OAUTH_TOKEN_ENDPOINT:-http://host.docker.internal:8080/oauth/token}
      NEED_DATABASE_SETUP: ${NEED_DATABASE_SETUP:-true}
      AppSettings__BypassStringTypeCoercion: ${BYPASS_STRING_COERCION:-false}
      AppSettings__AllowIdentityUpdateOverrides: ${ALLOW_IDENTITY_UPDATE_OVERRIDES:-}
      Serilog__MinimumLevel__Default: ${LOG_LEVEL:-DEBUG}
      # Mask incoming HTTP POST and PUT request body structures in DEBUG logging
      AppSettings__MaskRequestBodyInLogs: ${MASK_REQUEST_BODY_IN_LOGS:-true}
      AppSettings__MaximumPageSize: ${MAXIMUM_PAGE_SIZE:-500}
      # Segment of the url to use as base for all request. The default path base is deliberately blank on the following line
      AppSettings__PathBase: ${PATH_BASE:-}
      AppSettings__UseReverseProxyHeaders: ${USE_REVERSE_PROXY_HEADERS:-false}
      # The default correlation id header is deliberately blank on the following line
      AppSettings__CorrelationIdHeader: ${CORRELATION_ID_HEADER:-}
      AppSettings__Datastore: ${DMS_DATASTORE:-postgresql}
      AppSettings__QueryHandler: ${DMS_QUERYHANDLER:-opensearch}
      ConnectionStrings__DatabaseConnection: ${DATABASE_CONNECTION_STRING:-host=dms-postgresql;port=5432;username=postgres;password=${POSTGRES_PASSWORD};database=${POSTGRES_DB_NAME};}
      DatabaseOptions__IsolationLevel: ${DATABASE_ISOLATION_LEVEL:-RepeatableRead}
      # "DATABASE_CONNECTION_STRING_ADMIN" can have alternate credentials with elevated permissions for creating database objects
      DATABASE_CONNECTION_STRING_ADMIN: ${DATABASE_CONNECTION_STRING_ADMIN:-host=dms-postgresql;port=5432;username=postgres;password=${POSTGRES_PASSWORD};database=${POSTGRES_DB_NAME};}
      CircuitBreaker__FailureRatio: ${FAILURE_RATIO:-0.01}
      CircuitBreaker__SamplingDurationSeconds: ${SAMPLING_DURATION_SECONDS:-10}
      CircuitBreaker__MinimumThroughput: ${MINIMUM_THROUGHPUT:-2}
      CircuitBreaker__BreakDurationSeconds: ${BREAK_DURATION_SECONDS:-30}
      ConnectionStrings__OpenSearchUrl: ${OPENSEARCH_URL:-http://dms-search:9200}
      ConfigurationServiceSettings__BaseUrl: ${CONFIG_SERVICE_URL:-http://dms-config-service:8081}
      ConfigurationServiceSettings__ClientId: ${CONFIG_SERVICE_CLIENT_ID:-CMSAuthMetadataReadOnlyAccess}
      ConfigurationServiceSettings__Scope: ${CONFIG_SERVICE_CLIENT_SCOPE:-edfi_admin_api/authMetadata_readonly_access}
      ConfigurationServiceSettings__ClientSecret: ${CONFIG_SERVICE_CLIENT_SECRET}
      ConfigurationServiceSettings__CacheExpirationMinutes: ${CACHE_EXPIRATION_MINUTES:-10}
      AppSettings__UseApiSchemaPath: ${USE_API_SCHEMA_PATH:-false}
      AppSettings__ApiSchemaPath: ${API_SCHEMA_PATH:-}
      Cors__SwaggerUIOrigin: ${DMS_SWAGGER_UI_URL:-http://localhost:8082}
      AppSettings__EnableManagementEndpoints: ${DMS_ENABLE_MANAGEMENT_ENDPOINTS:-false}
      AppSettings__DomainsExcludedFromOpenApi: ${DOMAINS_EXCLUDED_FROM_OPEN_API:-}
      SCHEMA_PACKAGES: ${SCHEMA_PACKAGES}
      # JWT Authentication
      JwtAuthentication__Authority: ${DMS_JWT_AUTHORITY:-}
      JwtAuthentication__Audience: ${DMS_JWT_AUDIENCE:-}
      JwtAuthentication__MetadataAddress: ${DMS_JWT_METADATA_ADDRESS:-}
      JwtAuthentication__RequireHttpsMetadata: ${DMS_JWT_REQUIRE_HTTPS_METADATA:-false}
      JwtAuthentication__RoleClaimType: ${DMS_JWT_ROLE_CLAIM_TYPE:-}
      JwtAuthentication__ClientRole: ${DMS_JWT_CLIENT_ROLE:-}
      JwtAuthentication__ClockSkewSeconds: ${DMS_JWT_CLOCK_SKEW_SECONDS:-30}
      JwtAuthentication__RefreshIntervalMinutes: ${DMS_JWT_REFRESH_INTERVAL_MINUTES:-60}
      JwtAuthentication__AutomaticRefreshIntervalHours: ${DMS_JWT_AUTOMATIC_REFRESH_INTERVAL_HOURS:-24}
    ports:
      - '127.0.0.1:${DMS_HTTP_PORTS}:${DMS_HTTP_PORTS}'
    networks:
      - dms
    restart: unless-stopped
    healthcheck:
      test: curl -s http://localhost:8080/health >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 50
    hostname: dms

networks:
  dms:
    external: true
