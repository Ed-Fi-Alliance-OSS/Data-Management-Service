# Batch API Code Review

## Findings

1. **DocumentId updates still require inline document.id values**  
   - `MatchingDocumentUuidsValidator` (src/dms/core/EdFi.DataManagementService.Core/Validation/MatchingDocumentUuidsValidator.cs:23-27) rejects any PUT without a body-level `id` matching the route id. In the batch handler, only the natural-key branch injects `doc["id"] = targetDocumentUuid` (src/dms/core/EdFi.DataManagementService.Core/Handler/BatchHandler.cs:219-223), while the documentId branch (lines 173-178) simply forwards the caller's payload unchanged. The design doc and BATCH-PER-OPERATION-PROCESSING explicitly state that batch updates should inject the supplied `documentId` so clients don't have to duplicate it in every payload. Right now any batch update that relies on the `documentId` field (and omits `document.id`) will fail with the 400 "Request body id must match the id in the url" error before we even hit validation or authorization.  
   - *Recommendation*: When `operation.DocumentId` is provided and the caller omits `document.id`, set `doc["id"] = operation.DocumentId` before running the validation pipeline so batch behavior matches `/data` semantics.

2. **Natural-key updates silently overwrite mismatched ids**  
   - The same block that injects the resolved UUID for natural-key requests unconditionally overwrites any `id` that was present in the payload (src/dms/core/EdFi.DataManagementService.Core/Handler/BatchHandler.cs:219-223). Because this happens before `ValidateMatchingDocumentUuidsMiddleware` executes, a client can send a body whose `id` points at a different document and the middleware will never see the mismatch. The single-resource PUT handler would have rejected that request. This is both a behavioral regression and a debugging headache because we now silently "fix" incorrect payloads instead of surfacing the error.  
   - *Recommendation*: Only inject the resolved UUID when the payload omits `id`. If `document.id` is present and differs from the resolved UUID, short-circuit with the same 400 response emitted by `ValidateMatchingDocumentUuidsMiddleware` to preserve existing contract.

3. **Natural-key lookups leak resource existence before authorization**  
   - To support natural-key updates/deletes, `BatchHandler` resolves the UUID inside the unit of work before it runs the per-operation pipeline or authorization (src/dms/core/EdFi.DataManagementService.Core/Handler/BatchHandler.cs:197-216). A missing record returns a 404 immediately, while an existing record proceeds into the pipeline and may later return 403 if the claim set disallows the action (`ResourceActionAuthorizationMiddleware` in src/dms/core/EdFi.DataManagementService.Core/ApiService.cs:219-252). That means callers without access to a resource can now probe predictable natural keys (e.g., `studentUniqueId`) via `/batch` and learn whether the record exists simply by checking whether the response is 404 or 403. The `/data` endpoints never expose that signal because authorization executes before the repository is touched.  
   - *Recommendation*: Prevent enumeration by masking the not-found outcome until after authorization. For example, resolve the natural key inside a component that first verifies the caller is authorized to act on that resource, or intentionally return the same status code (e.g., 404) for both "not found" and "forbidden" when the request is targeting a resource outside the caller's claim sets. Either approach restores parity with the existing endpoints and avoids leaking sensitive existence information.

