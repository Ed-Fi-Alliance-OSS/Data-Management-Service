[
  {
    "category": "Constraints",
    "description": "Introduce synthetic presence hardening via `TableConstraint.NullOrTrue`. Acceptance: `src/dms/backend/EdFi.DataManagementService.Backend.External/RelationalModelTypes.cs` defines `TableConstraint.NullOrTrue(string Name, DbColumnName Column)`; constraint naming/identity/dialect hashing/shortening all support it; manifest JSON serialization supports it; and `RelationalModelDdlEmitter` has minimal Pgsql/Mssql emission support (enough to keep unit tests green).",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.Ddl.Tests.Unit/EdFi.DataManagementService.Backend.Ddl.Tests.Unit.csproj`",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Key Unification",
    "description": "Align `KeyUnificationPass` to the design: strict endpoint resolution by exact `DbColumnModel.SourceJsonPath.Canonical` only (delete `FindReferenceRelativeAliasCandidates` and `TryResolveAmbiguousReferenceEndpoint` heuristics), fail fast on unresolved/ambiguous endpoints and unsupported endpoint kinds, derive canonical stored columns + `ColumnStorage.UnifiedAlias` members with correct presence gating, and emit one `TableConstraint.NullOrTrue` per synthetic `..._Present` column. Acceptance: same-table applied constraints produce exactly one canonical stored column (`SourceJsonPath=null`) per class; unified members retain binding column names + `SourceJsonPath` and become aliases; reference-site aliases gate by `..._DocumentId`; optional non-reference aliases gate by synthetic presence flags; `DbTableModel.KeyUnificationClasses` ordering is deterministic and stable across runs.",
    "steps-to-verify": [
      "Add/extend minimal unit tests in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/KeyUnificationPassTests.cs` for strict endpoint resolution, synthetic presence + NullOrTrue, and cross-table ignored constraints.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Descriptor FKs",
    "description": "Refactor descriptor FK constraint emission into a post-unification pass. Acceptance: remove early descriptor FK constraint creation in `ReferenceBindingPass` and `ExtensionTableDerivationPass`; add a new set-level pass (after `KeyUnificationPass`) that maps descriptor binding columns to storage columns (canonical when unified), emits exactly one FK to `dms.Descriptor(DocumentId)` per `(table, storage_column)` pair, and de-duplicates multiple binding columns mapping to the same storage column; descriptor FK constraint names are derived from `(table, storage_column)` so they are stable under dedup.",
    "steps-to-verify": [
      "Add a minimal synthetic-schema unit test where two descriptor binding columns unify to one canonical storage column and assert only one descriptor FK constraint is emitted.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Reference Constraints",
    "description": "Update reference constraint derivation to target storage columns under unification. Acceptance: in `ReferenceConstraintPass`, map both local and target identity-part columns through `DbColumnModel.Storage` (use `UnifiedAliasStorageResolver`) and de-duplicate repeated canonical storage columns after mapping while preserving identityJsonPaths order; ensure FK-supporting referenced-key UNIQUE constraints use the mapped (and deduped) target storage columns; all-or-none constraints remain on binding/path columns + `..._DocumentId` (no storage mapping).",
    "steps-to-verify": [
      "Add/extend unit tests in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs` that exercise identity-part unification causing duplicate storage columns and assert FK/UK dedup with stable ordering.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Dialect & Ordering",
    "description": "Fix dialect shortening + deterministic ordering for key unification metadata. Acceptance: `ApplyDialectIdentifierShorteningPass` rewrites `ColumnStorage.UnifiedAlias` pointers (canonical/presence), `DbTableModel.KeyUnificationClasses` references, and `TableConstraint.NullOrTrue.Column`; canonical ordering guarantees the alias-dependency invariant (for every `UnifiedAlias`, its canonical and presence columns—including reference-site `..._DocumentId`—appear earlier) and places canonical + synthetic presence columns before dependent aliases.",
    "steps-to-verify": [
      "Add unit tests for identifier shortening rewriting and for column-order dependency invariants.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Manifests",
    "description": "Emit key-unification diagnostics in manifest JSON without adding them to in-memory contracts. Acceptance: `RelationalModelManifestEmitter` emits `key_unification_equality_constraints` in the design-doc shape and always present (empty arrays when none): `applied`/`redundant`/`ignored` + `ignored_by_reason`; endpoint paths are canonicalized to undirected `(minPath,maxPath)` ordering while preserving duplicate ApiSchema entries; ignored.reason supports only `cross_table`; applied entries include resolved endpoint binding columns and the final `canonical_column`. Also emit per-table `descriptor_fk_deduplications` always present (empty when none) with deterministic ordering and including `constraint_name` for each dedup group.",
    "steps-to-verify": [
      "Update `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelManifestEmitterTests.cs` to assert new properties exist and are empty when appropriate.",
      "Add a focused minimal-schema test that produces applied/redundant/cross_table cases and asserts the emitted report shape and ordering.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Goldens",
    "description": "Update authoritative DS 5.2 fixtures/goldens to validate end-to-end behavior. Acceptance: `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelAuthoritativeGoldenTests.cs` switches to set-level `DerivedRelationalModelSetBuilder` for `Fixtures/authoritative/ds-5.2/expected/authoritative-relational-model.manifest.json` so reference binding + key unification + diagnostics execute; `DerivedRelationalModelSetAuthoritativeGoldenTests.cs` includes `Ed-Fi.StudentAssessmentRegistration` and `Ed-Fi.ProgramEvaluationElement` in `resource_details` for key-unification coverage; goldens pass without `UPDATE_GOLDENS`, and no `RelationalMappingVersion` bump is introduced (fixtures may remain on existing version strings such as `1.0.0`).",
    "steps-to-verify": [
      "Regenerate goldens once: `UPDATE_GOLDENS=1 dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Verify clean diff: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Docs",
    "description": "Update mapping-pack/proto surfaces in design docs only (no new in-repo .proto project). Acceptance: `reference/design/backend-redesign/design-docs/mpack-format-v1.md` updates `TableConstraint` to cover `AllOrNoneNullability`, `NullOrTrue`, and FK referential actions (on_delete/on_update) while keeping existing key-unification payload additions (`DbColumnModel.storage`, `DbTableModel.key_unification_classes`, write-plan precomputed + key-unification plans); docs reflect that this repo is not bumping `RelationalMappingVersion` yet.",
    "steps-to-verify": [
      "Review doc diff: `git diff -- reference/design/backend-redesign/design-docs/mpack-format-v1.md`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  }
]
