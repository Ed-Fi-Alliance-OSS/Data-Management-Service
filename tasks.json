[
  {
    "category": "Naming",
    "description": "DMS-931: Apply dialect identifier shortening into the derived model (not just collision detection), including schema names. Today `RelationalModelSetBuilderContext.BuildResult` detects shortening collisions, but the model still stores pre-shortened identifiers, forcing every downstream consumer to remember to shorten consistently. Acceptance: (1) A set-level pass rewrites *all* derived identifiers using `context.DialectRules.ShortenIdentifier` and stores the shortened names in the `DerivedRelationalModelSet` (schemas, tables, columns, constraints, indexes, triggers, abstract identity tables/views); (2) all internal references are updated consistently (FK `TargetTable/TargetColumns`, `DocumentReferenceBinding.Table/FkColumn/IdentityBindings`, `DescriptorEdgeSource`, index/trigger `Table/KeyColumns`, etc.); (3) the pass is deterministic and idempotent (running twice yields the same model); (4) collision detection still fails fast when multiple original identifiers shorten to the same value, using the structured collision record format; (5) unit tests cover overlong table/column/constraint/index/trigger/schema names and assert the shortened identifiers are present in the output and referenced correctly; (6) all unit tests pass and the DMS solution builds.",
    "steps-to-verify": [
      "Implement a new set-level pass (e.g., `ApplyDialectIdentifierShorteningRelationalModelSetPass`) that rewrites identifiers in-place on `RelationalModelSetBuilderContext` inventories using `DialectRules.ShortenIdentifier` and updates all references consistently (including `ProjectSchemasInEndpointOrder[*].PhysicalSchema`).",
      "Register the pass in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/RelationalModelSetPasses.cs` after the DMS-931 naming/override/constraint-naming pass and before `CanonicalizeOrderingRelationalModelSetPass`.",
      "Add unit tests that force overlong identifiers (including schema names) and assert the shortened names are stored in the resulting `DerivedRelationalModelSet` and referenced correctly by constraints/bindings/inventories. Include at least one Pgsql (63-byte) and one Mssql (128-char) case.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Testing",
    "description": "DMS-931: Add “naming-stress” hand-authored fixtures + extend authoritative expected outputs (inputs unchanged). Acceptance: (1) New unit tests are built from `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/set-builder/*` fixtures and exercise: long names, `rootTableNameOverride`, scalar/reference/array overrides (including nested-array remainder ordinal naming, inside-reference identity overrides, and nested collection override compatibility without descendant/prefix requirements), extension-schema override auto-prefixing, reserved-word/edge-case normalization, and collision diagnostics; (2) authoritative fixture inputs remain unchanged; only `expected/` outputs are updated to reflect new naming/override/constraint-naming/shortening behavior; (3) the authoritative derived model set JSON comparisons pass; (4) the DMS solution builds.",
    "steps-to-verify": [
      "Add/extend hand-authored fixture inputs under `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/set-builder/` to cover naming stress scenarios without requiring changes to authoritative inputs.",
      "Update authoritative `expected/authoritative-derived-relational-model-set.json` files to match the new deterministic naming + constraint naming + shortening behavior.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Design",
    "description": "DMS-931: Update backend-redesign override design docs to match authoritative goldens (inside-reference identity overrides allowed; relaxed collection override rules). Acceptance: (1) `reference/design/backend-redesign/design-docs/flattening-reconstitution.md` no longer states that identity paths inside reference objects are invalid; it distinguishes reference-object overrides vs reference-identity overrides and constrains inside-reference overrides to reference identity JSONPaths; (2) the doc removes any requirement that nested collection override values start with the parent suffix or that descendant collection overrides are required; (3) the doc states collection override values are interpreted as the collection segment/base name and allows fully-qualified values via deterministic stripping of already-implied root/ancestor prefixes; (4) examples include at least one inside-reference identity override and one ancestor-only collection override.",
    "steps-to-verify": [
      "Update `reference/design/backend-redesign/design-docs/flattening-reconstitution.md` sections 3.2/3.3 to reflect the updated rules (reference-object override vs reference-identity override; relaxed collection rules; prefix-stripping compatibility) and add/adjust examples accordingly.",
      "Confirm `reference/design/backend-redesign/design-docs/flattening-reconstitution.md` language matches the updated DMS-931 acceptance text in `tasks.json` (no contradictions)."
    ],
    "completed": true
  },
  {
    "category": "Backend",
    "description": "DMS-931: Allow inside-reference identity overrides during input validation (reject non-identity inside-reference keys). Acceptance: (1) `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtractInputsStep.cs` allows an override key inside a reference object only if it exactly matches one of the mapping’s `ReferenceJsonPaths[*].ReferenceJsonPath` canonicals; (2) authoritative overrides like `$.graduationSchoolYearTypeReference.schoolYear` are accepted; (3) non-identity inside-reference keys (e.g., `$.schoolReference.link`) still fail fast with diagnostics that include raw key text + canonical form.",
    "steps-to-verify": [
      "Update inside-reference validation in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtractInputsStep.cs` (near the existing inside-reference failure) to allow only reference identity JSONPaths from the mapping and to fail fast on other inside-reference keys.",
      "Update/add unit tests in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/SchemaInputValidationTests.cs` to cover allowed inside-reference identity override and rejected non-identity inside-reference key.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Backend",
    "description": "DMS-931: Apply inside-reference identity overrides to propagated reference identity column base names. Acceptance: (1) `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ReferenceBindingRelationalModelSetPass.cs` consults `nameOverrides` for each `identityBinding.ReferenceJsonPath` and applies the override value to the propagated identity column base name when present; (2) any binding metadata that depends on the identity column base name is updated consistently so downstream lookups/reconstitution use the overridden names; (3) if both a reference-object override and an inside-reference identity override are present, the identity override wins for the specific identity column while the reference-object override still applies to the reference bundle artifacts (FK `..._DocumentId`, etc.).",
    "steps-to-verify": [
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ReferenceBindingRelationalModelSetPass.cs` to consult `TryGetNameOverride(identityBinding.ReferenceJsonPath, Column)` (or equivalent) when creating propagated identity columns and apply the override to the identity column base name.",
      "Add/adjust unit tests to assert a reference identity column can be renamed via an inside-reference identity override without renaming non-identity keys inside the reference.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Backend",
    "description": "DMS-931: Relax collection override derivation (no descendant override requirement; no parent-prefix requirement) and add prefix-stripping compatibility. Acceptance: (1) `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/DeriveTableScopesAndKeysStep.cs` and `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtensionTableDerivationRelationalModelSetPass.cs` no longer throw when an ancestor collection override exists without descendant overrides; (2) nested collection override values do not need to start with the parent suffix; (3) collection override values are resolved to an effective segment by deterministically stripping already-implied root/ancestor prefixes when present, so segment-only and fully-qualified values produce the same derived names; (4) authoritative fixture shapes like `CommunityOrganization` with only `$.indicators[*]` override build successfully.",
    "steps-to-verify": [
      "Remove the \"descendant override required\" checks from `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/DeriveTableScopesAndKeysStep.cs` and `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtensionTableDerivationRelationalModelSetPass.cs`.",
      "Replace the strict `StartsWith(parentSuffix)` logic in both files with a compatibility resolver that computes the effective segment/base name and deterministically strips implied root/ancestor prefixes when present (no hard requirement).",
      "Update/add unit tests in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/NameOverrideTests.cs` to cover missing descendant overrides and nested overrides without parent-prefix requirements.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Testing",
    "description": "DMS-931: Update schema input validation tests for inside-reference identity overrides. Acceptance: (1) `SchemaInputValidationTests` accepts an inside-reference override whose key matches a reference identity JSONPath from the mapping; (2) it rejects a non-identity inside-reference key such as `$.schoolReference.link`.",
    "steps-to-verify": [
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/SchemaInputValidationTests.cs` to add/adjust tests around the existing inside-reference validation coverage.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Testing",
    "description": "DMS-931: Update override derivation tests to allow missing descendant collection overrides. Acceptance: (1) The previous \"missing descendant override\" fixture no longer throws; (2) tests assert the expected derived table scope names/keys when an ancestor collection override exists without a descendant override.",
    "steps-to-verify": [
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/NameOverrideTests.cs` (near the existing descendant override test) to assert successful build + expected naming behavior instead of asserting an exception.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Testing",
    "description": "DMS-931: Add a focused unit test proving nested collection overrides work without the parent-prefix form (and that fully-qualified values are compatible). Acceptance: (1) A nested collection override value that does not start with the parent suffix is accepted; (2) a fully-qualified nested override value that includes implied prefixes yields the same effective derived names as the segment-only form.",
    "steps-to-verify": [
      "Add a new unit test (and any minimal fixture) under `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/` covering nested collection override segment resolution and prefix-stripping compatibility.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Verification",
    "description": "DMS-931: Verify override alignment changes against authoritative goldens. Acceptance: (1) `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj` passes; (2) `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln` succeeds; (3) no authoritative input fixtures were modified (only code/docs/expected outputs as needed).",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`",
      "Confirm no changes under `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/*/inputs/`."
    ],
    "completed": true
  },
  {
    "category": "Validation",
    "description": "DMS-931 follow-up: Close collision detection gaps for direct duplicate identifiers by updating `OverrideCollisionDetector` and `IdentifierCollisionDetector` to collide on multiple distinct origins, not only multiple distinct original identifier strings. Acceptance: (1) Build fails when two distinct derived elements share the same final identifier in a collision scope even when their original identifier strings are identical (e.g., root table name collisions created by `rootTableNameOverride`); (2) de-duplication only suppresses truly duplicate registrations of the same element (same origin), not distinct derived elements; (3) diagnostics remain deterministic and include the collision stage, scope, and origin details (resource label + JSONPath) for each conflicting source; (4) existing collision tests remain passing.",
    "steps-to-verify": [
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/OverrideCollisionDetector.cs` to treat multiple unique origins for the same final identifier as a collision even when `OriginalIdentifier` matches.",
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/IdentifierCollisionDetector.cs` to treat multiple unique origins for the same shortened identifier as a collision even when `OriginalIdentifier` matches.",
      "Ensure collision-source ordering remains deterministic (Ordinal) and stage labels remain accurate (`AfterOverrideNormalization`, `AfterDialectShortening`).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Testing",
    "description": "DMS-931 follow-up: Add regression tests covering `rootTableNameOverride` collisions (root-vs-root and root-vs-child table name collisions). Acceptance: (1) A fixture where two resources in the same physical schema resolve to the same root table name via `relational.rootTableNameOverride` fails fast during derived model build; (2) a fixture where a resource root table name collides with another resource's child collection table name fails fast; (3) the exception message includes both resources and the colliding identifiers with actionable origins (resource label + JSON scope/path); (4) behavior is deterministic across resource ordering.",
    "steps-to-verify": [
      "Add a minimal hand-authored fixture under `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/set-builder/` containing two resources that collide via `rootTableNameOverride`.",
      "Add a second fixture where `rootTableNameOverride` produces a root table name that collides with another resource's derived child table name.",
      "Add a new NUnit fixture (e.g., `RootTableNameOverrideCollisionTests`) asserting the build throws `InvalidOperationException` with an actionable collision record.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Refactor",
    "description": "DMS-931 follow-up: Remove the unused `hasOverriddenAncestor` state in collection table derivation to reduce complexity. Acceptance: (1) `hasOverriddenAncestor` is either removed from `DeriveTableScopesAndKeysStep` / `ExtensionTableDerivationRelationalModelSetPass` (and any callers) or used for a clearly-defined behavior; (2) derived outputs are unchanged (goldens + unit tests stay green); (3) no dead code remains.",
    "steps-to-verify": [
      "Verify `hasOverriddenAncestor` is unused in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/DeriveTableScopesAndKeysStep.cs` and `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtensionTableDerivationRelationalModelSetPass.cs`.",
      "Remove the parameter and all plumbing (or introduce a tested behavior if it is intended to mean something).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Cleanup",
    "description": "DMS-931 follow-up: Remove the unused legacy helper `RelationalNameConventions.ForeignKeyName` (superseded by `ConstraintNaming`) to prevent accidental divergence of naming rules. Acceptance: (1) The helper is removed and no call sites depend on it; (2) constraint naming uses `ConstraintNaming` consistently; (3) build and unit tests remain green.",
    "steps-to-verify": [
      "Confirm no usages of `RelationalNameConventions.ForeignKeyName` remain outside the helper itself.",
      "Remove the helper from `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/RelationalNameConventions.cs` (or mark obsolete and add a follow-up task to remove).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Refactor",
    "description": "DMS-931 follow-up: Remove brittle runtime type assumptions in `ApplyDialectIdentifierShorteningRelationalModelSetPass.UpdateProjectSchemas`. Acceptance: (1) Dialect shortening can update `ProjectSchemasInEndpointOrder` without throwing when the backing collection is not a mutable array/list; (2) behavior remains deterministic and stable across runs; (3) unit tests cover schema-shortening behavior; (4) build and unit tests remain green.",
    "steps-to-verify": [
      "Refactor `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/RelationalModelSetBuilderContext.cs` to expose a consistently-mutable representation for `ProjectSchemasInEndpointOrder` (or provide an explicit mutation method) so passes do not depend on the concrete backing type.",
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ApplyDialectIdentifierShorteningRelationalModelSetPass.cs` to use the new mutation approach and remove the runtime type checks/throw.",
      "Add/adjust a unit test under `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/` that exercises schema shortening via a small `MaxIdentifierLength` and asserts updated `PhysicalSchema` values.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Testing",
    "description": "Add a new ds-5.2 golden test that validates reference binding by building a `DerivedRelationalModelSet` (set-level passes) and emitting a project-level manifest to a new expected fixture. Acceptance: (1) A new NUnit fixture builds a derived model set from `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/ds-5.2/inputs/ds-5.2-api-schema-authoritative.json` using `RelationalModelSetPasses.CreateDefault()`; (2) it writes/diffs a new expected file `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/ds-5.2/expected/authoritative-relational-model.derived.manifest.json`; (3) the derived manifest for `studentAssessmentRegistrations` includes reference-bound columns for the `StudentSchoolAssociation` reference (at minimum `StudentSchoolAssociation_DocumentId` and `StudentSchoolAssociation_StudentReferenceStudentUniqueId`) on the `StudentAssessmentRegistration` root table; (4) the existing per-resource ds-5.2 golden (`authoritative-relational-model.manifest.json`) remains unchanged and still passes.",
    "steps-to-verify": [
      "Add a new NUnit golden test file (e.g., `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelDerivedAuthoritativeGoldenTests.cs`) that loads the ds-5.2 project schema, builds an `EffectiveSchemaSet`, then builds a `DerivedRelationalModelSet` with `RelationalModelSetPasses.CreateDefault()` (plus an extension-site capture pass for per-resource emission).",
      "Emit the derived project-level manifest in the same top-level shape as the existing ds-5.2 manifest (`project_*` + `resources[]` with `resource_endpoint_name` + per-resource manifest), using `RelationalModelManifestEmitter.Emit(concrete.RelationalModel, extensionSites)` for each resource.",
      "Ensure the test writes an `actual` file under the test work directory and diffs it against the new expected fixture file, failing with the diff output when mismatched.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Confirm reference binding is present by searching the expected derived manifest for `StudentSchoolAssociation_DocumentId` and `StudentSchoolAssociation_StudentReferenceStudentUniqueId`.",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Fixtures",
    "description": "Add and maintain the derived ds-5.2 expected golden manifest for reference binding. Acceptance: (1) `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/ds-5.2/expected/authoritative-relational-model.derived.manifest.json` exists in source control; (2) running the new derived golden test without `UPDATE_GOLDENS` produces no diff; (3) running with `UPDATE_GOLDENS=1` rewrites the file deterministically (stable ordering, LF-only, no trailing whitespace).",
    "steps-to-verify": [
      "Generate the expected derived manifest by running: `UPDATE_GOLDENS=1 dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Re-run the same test without `UPDATE_GOLDENS` and ensure it passes with an empty diff.",
      "Spot-check the expected derived manifest contains reference-bound columns for `studentAssessmentRegistrations` (e.g., `StudentSchoolAssociation_DocumentId`).",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  }
]
