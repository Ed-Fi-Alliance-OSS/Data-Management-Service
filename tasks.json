[
  {
    "category": "Contracts",
    "description": "Add a structured CHECK-constraint model for reference groups: introduce `TableConstraint.AllOrNoneNullability` (include deterministic `Name`, `FkColumn`, and the dependent identity columns). Acceptance: `DerivedRelationalModelSet` can represent all-or-none reference-group constraints without embedding SQL; `CanonicalizeOrderingStep`, collision detection, and manifest emission handle the new constraint type deterministically; name pattern is `CK_{TableName}_{FkColumn}_AllOrNone`.",
    "steps-to-verify": [
      "Add/extend unit tests asserting deterministic ordering and manifest serialization for the new constraint type.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Schema Inputs",
    "description": "Implement schema readers/validators for this story’s inputs: `documentPathsMapping` reference entries (must have `referenceJsonPaths`, fail-fast otherwise, and validate each `referenceJsonPaths[*].identityJsonPath` exists in the target resource’s `identityJsonPaths`), `arrayUniquenessConstraints` (object-based format including `basePath` and recursive `nestedConstraints`, where nested `paths` are JSONPaths relative to the base item), `allowIdentityUpdates`, and `relational.nameOverrides` (use only for reference base-name overrides in this story; do not fail-fast on unrelated overrides). Acceptance: all malformed/missing/mismatched inputs fail fast with actionable messages (unmapped identityJsonPaths, unmapped arrayUniquenessConstraints paths/basePath, inconsistent referenceJsonPaths prefix, missing referenceJsonPaths on references, nestedConstraints missing basePath, mismatched `isPartOfIdentity` vs actual identityJsonPaths usage, referenceJsonPaths identityJsonPath not in target identityJsonPaths).",
    "steps-to-verify": [
      "Add synthetic unit tests that exercise each fail-fast condition with clear diagnostics.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Column Derivation",
    "description": "Refactor column derivation to suppress reference-object identity fields from being emitted as ordinary scalar/descriptor columns (they must only exist as `{RefBaseName}_{IdentityPart}` propagated identity columns created by this story). Acceptance: no duplicate data columns are emitted for reference identity fields; descriptor-path enforcement does not fail due to suppressed reference-identity descriptor paths; no `link` internals are emitted (inputs shouldn’t have them, but suppression remains safe).",
    "steps-to-verify": [
      "Add a unit test proving a reference identity field path does not produce a `...Reference_...` scalar/descriptor column, and that the pipeline still succeeds.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Extensions",
    "description": "Implement 'just enough DMS-932' extension-table modeling to host reference sites under `_ext` now: associate resource-extension schemas to base resources by matching `resourceName` across projects and extension project key = extension project endpoint name; derive extension tables by walking the resource-extension `jsonSchemaForInsert` payloads (base resource schemas may not contain `_ext`) and mapping those extension scopes back onto the owning base resource scopes for key alignment; derive scope-aligned extension tables and extension child tables (arrays under `_ext`) per `extensions.md`, including scalar columns and descriptor FK columns. Acceptance: extension tables live in the extension project schema, keys align exactly to the base scope keys (including ordinals), and extension tables can host document references and descriptors under `_ext` (including arrays under `_ext`).",
    "steps-to-verify": [
      "Add a synthetic fixture with `_ext` at root and inside a collection (including an array under `_ext` containing a reference) and assert expected extension table names + key alignment + FK-to-base with `ON DELETE CASCADE`.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Abstract Identity",
    "description": "Implement 'just enough DMS-933' to derive `{schema}.{Abstract}Identity` table models used as composite FK targets: determine participating concrete resources using `isSubclass`/`superclassProjectName`/`superclassResourceName`; identity column ordering comes from abstract `identityJsonPaths`; infer abstract identity column types from participating concrete member identity columns and fail-fast if any member type differs; include a `Discriminator` column; add FK `DocumentId -> dms.Document(DocumentId) ON DELETE CASCADE`; always add the target-side UNIQUE needed for composite FKs. Acceptance: abstract identity tables are present in `DerivedRelationalModelSet.AbstractIdentityTablesInNameOrder` and are usable as FK targets; ON UPDATE CASCADE is never emitted for FKs targeting abstract identity tables.",
    "steps-to-verify": [
      "Add unit tests asserting (a) column ordering equals `identityJsonPaths` order, (b) discriminator exists, (c) required UNIQUE exists, and (d) abstract targets never get `ON UPDATE CASCADE`.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Reference Binding",
    "description": "Bind document references from `documentPathsMapping.referenceJsonPaths`: for each reference site, create a `..._DocumentId` column at the owning table scope (base or extension) and propagated identity columns `{RefBaseName}_{IdentityPart}` at the same scope; descriptor identity parts inside a reference object are stored as reference-aligned `..._DescriptorId` columns (e.g. `Program_ProgramTypeDescriptor_DescriptorId`) and must contribute `DescriptorEdgeSource` metadata and an FK constraint to `dms.Descriptor(DocumentId)`; populate `RelationalResourceModel.DocumentReferenceBindings` (including deterministic `IdentityBindings` ordering) with correct `IsIdentityComponent` classification; reference base name comes from the mapping entry key with `relational.nameOverrides` escape hatch; nested identity paths (e.g. `$.staffReference.staffUniqueId`) use expanded naming. Acceptance: references inside nested collections bind to the correct child table; references under `_ext` bind to the correct extension tables; `documentPathsMapping.isRequired` is the source of truth for reference-group nullability (do not derive it from JSON Schema required/x-nullable rules).",
    "steps-to-verify": [
      "Add unit tests covering: nested reference scope selection, `IsIdentityComponent` true/false, nested-identity naming, and descriptor-identity naming inside reference objects.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Constraints",
    "description": "Derive root-table natural-key UNIQUE constraints from canonical `identityJsonPaths`: map scalar identities to scalar columns; map descriptor identities to `*_DescriptorId`; map identity paths under document references to the reference’s `..._DocumentId` column (de-dupe if multiple identity paths share the same reference). For descriptor resources (`SharedDescriptorTable`), ensure the shared descriptor table model includes `Uri` and `Discriminator` columns (not present in `jsonSchemaForInsert`) and derive UNIQUE `(Uri, Discriminator)` even when `identityJsonPaths` is empty. Acceptance: root UNIQUE matches design rules and fails fast when an identityJsonPath cannot be mapped.",
    "steps-to-verify": [
      "Add unit tests for: identity paths under a reference de-dupe to a single `..._DocumentId`, descriptor resource UNIQUE uses `(Uri, Discriminator)` with empty identityJsonPaths, and unmapped identityJsonPaths fail fast.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Constraints",
    "description": "Derive child-table UNIQUE constraints from `arrayUniquenessConstraints` (including recursive `nestedConstraints`): determine owning child table by wildcard scope; map each uniqueness path to a column, including mapping paths inside reference objects to the reference’s `..._DocumentId` (de-dupe); scope each UNIQUE by the parent key parts (root document id + ancestor ordinals), excluding the current `Ordinal`; column ordering is: parent key parts (key order) then mapped uniqueness columns in `paths` order. For nestedConstraints, use `basePath` as the parent wildcard scope and treat nested `paths` as relative-to-item JSONPaths when resolving the owning child table. Acceptance: constraints are deterministic, enforce uniqueness per parent, and fail fast on unmapped paths.",
    "steps-to-verify": [
      "Add unit tests proving parent key parts are included, `Ordinal` is excluded, reference-inner paths bind to `..._DocumentId`, and unknown paths fail fast.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Constraints",
    "description": "Add per-reference constraints: (1) a structured all-or-none constraint (`AllOrNoneNullability`) per reference site, and (2) composite FKs from `(Ref_DocumentId, Ref_{IdentityParts...})` to the target identity key `(DocumentId, IdentityParts...)` with deterministic column ordering following the target resource’s `identityJsonPaths` order. Applies equally to reference sites on base tables and extension tables. Reference-group nullability is sourced from `documentPathsMapping.isRequired`. Acceptance: `ON UPDATE CASCADE` is only emitted when the concrete target has `allowIdentityUpdates: true`; abstract targets never allow `ON UPDATE CASCADE`; `ON DELETE` is always `NO ACTION`; and the required target-side UNIQUE for composite FKs is modeled on referenced tables (concrete roots and abstract identity tables), using the target’s natural-key value columns (including propagated reference-derived identity columns).",
    "steps-to-verify": [
      "Add unit tests for allowIdentityUpdates gating, abstract-target non-cascade, target-identity ordering, and presence of target-side UNIQUE.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Set-Level Integration",
    "description": "Wire this story into `DerivedRelationalModelSetBuilder` as ordered whole-schema passes: base traversal, extension-table modeling, abstract identity-table modeling, then reference binding + constraint derivation. Acceptance: pass ordering is deterministic, all passes operate over projects/resources in canonical order, and the final `DerivedRelationalModelSet` is stable across input ordering and JSON property ordering.",
    "steps-to-verify": [
      "Update/extend determinism and pass-ordering unit tests to include the new passes.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Tests",
    "description": "Add new synthetic fixtures and unit tests (NUnit + FluentAssertions) covering: nested references in collections (scope selection), identity-component classification, all fail-fast validations, allowIdentityUpdates gating, reference-group nullability source-of-truth (`documentPathsMapping.isRequired`), and constraints mapping for array uniqueness and reference groups. Acceptance: tests are small, readable, and isolate behavior; failures are deterministic and diagnostic.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Manifests",
    "description": "Expand the authoritative `DerivedRelationalModelSet` manifest used by `DerivedRelationalModelSetAuthoritativeGoldenTests` so goldens can cover this story’s output: include abstract identity tables (table name, columns in identity order, constraints), and include a curated subset of concrete resources with their tables/columns/constraints (including reference-derived columns, UNIQUEs, composite FKs, and all-or-none constraints) plus a summary of `DocumentReferenceBindings`. Acceptance: manifest output is deterministic, stable across runs/input ordering, and kept to a manageable size for the ds-5.2 + sample fixtures.",
    "steps-to-verify": [
      "Update/extend the authoritative derived-set golden test to use the expanded manifest and regenerate expected output via `UPDATE_GOLDENS=1`.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Goldens",
    "description": "Update authoritative fixture goldens for both `ds-5.2` and `sample` to reflect reference binding, constraints, extension tables, and abstract identity tables. This may require enhancing the authoritative derived-set manifest output to include the newly-derived inventories (potentially for a curated subset of resources to keep output size reasonable). This also includes updating the per-resource authoritative manifest (currently `dms-929-relational-model.manifest.json`) impacted by reference-identity column suppression. Acceptance: authoritative golden tests pass with no diff; goldens are regenerated only via `UPDATE_GOLDENS=1` and remain stable across runs.",
    "steps-to-verify": [
      "Run: `UPDATE_GOLDENS=1 dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Build",
    "description": "Ensure the DMS solution builds cleanly after the story implementation. Acceptance: no new build warnings/errors introduced by the relational model changes.",
    "steps-to-verify": [
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Constraints",
    "description": "Fix abstract reference propagation mismatch: design requires composite FKs to `{schema}.{AbstractResource}Identity(DocumentId, <IdentityParts...>)` with `ON UPDATE CASCADE`, but current derivation uses `ReferentialAction.NoAction` for abstract targets. Update `ConstraintDerivationRelationalModelSetPass` so abstract-target `TableConstraint.ForeignKey.OnUpdate` is `ReferentialAction.Cascade`. Acceptance: (1) For abstract reference sites, the derived FK targets the abstract identity table and uses `OnUpdate: Cascade`; (2) the FK column order remains `DocumentId` + identity parts in target identity order; (3) concrete-target `allowIdentityUpdates` gating remains unchanged; (4) unit tests are updated to assert the cascade behavior for abstract targets.",
    "steps-to-verify": [
      "Update unit test `Given_Abstract_Reference_Constraint_Derivation` in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs` to expect `ReferentialAction.Cascade` for the abstract-target FK.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Descriptor Paths",
    "description": "Remove descriptor-identity inference “guess” path: `ReferenceBindingRelationalModelSetPass.TryResolveDescriptorIdentity` currently falls back to inferring descriptor identity by checking if the last segment ends with `\"Descriptor\"`. Remove this heuristic and require that descriptor identity paths must be present in the descriptor-path map (`RelationalModelSetBuilderContext.GetAllDescriptorPathsForResource`). Acceptance: (1) If an identityJsonPath is a descriptor identity part but is not present in the descriptor-path map, model compilation fails fast with an actionable error including target resource and path; (2) no descriptor identity columns are derived via naming heuristics; (3) existing happy-path reference binding (where descriptor paths are present) continues to pass all tests.",
    "steps-to-verify": [
      "Remove the `EndsWith(\"Descriptor\")` fallback in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ReferenceBindingRelationalModelSetPass.cs` and throw when the descriptor-path map does not contain the identity path.",
      "Add a unit test that constructs a reference mapping whose `identityJsonPath` ends with `Descriptor` but is not present in the descriptor-path map, and assert an `InvalidOperationException` with path/resource details.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Constraints",
    "description": "Fail fast on incomplete abstract identity mappings: `ConstraintDerivationRelationalModelSetPass` currently skips abstract-target reference constraints when the reference mapping does not include all abstract identity parts (it `continue`s). Change behavior to throw with missing identity parts. Acceptance: (1) For abstract targets, if the reference mapping is missing any identityJsonPath required by `{Abstract}Identity`, compilation fails with an exception that lists the missing identityJsonPaths and identifies the source resource + mapping key; (2) no silent omissions for abstract reference constraints; (3) a unit test covers this failure case deterministically.",
    "steps-to-verify": [
      "Change abstract-target handling in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ConstraintDerivationRelationalModelSetPass.cs` so incomplete identity results in an exception (include missing identity paths in the message).",
      "Add a unit test that builds an abstract target reference mapping with missing identity part(s) and asserts the fail-fast exception message includes the missing identity path(s).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Constraints",
    "description": "Fail fast on missing target identityJsonPaths for concrete reference mappings: reference identity completeness is currently optional because missing target identity paths are silently skipped when building composite FK columns. Update derivation/validation so a document reference mapping must bind every target identityJsonPath to a local column for concrete targets. Acceptance: (1) For concrete targets, if `documentPathsMapping.referenceJsonPaths[*].identityJsonPath` does not cover the full target `identityJsonPaths` set, compilation fails with an error listing missing target identityJsonPaths; (2) FK column order remains deterministic and matches target identity order; (3) a unit test covers the missing-identity failure case.",
    "steps-to-verify": [
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ConstraintDerivationRelationalModelSetPass.cs` (or set-level validation) to detect missing target identityJsonPaths for concrete references and throw with a list of missing paths.",
      "Add a unit test that creates a concrete target with multiple identityJsonPaths but supplies only a subset in `referenceJsonPaths`, and assert the fail-fast exception includes the missing identity path(s).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Schema Inputs",
    "description": "Make `isPartOfIdentity` validation bi-directional: currently validation fails only when identityJsonPaths includes a mapping path but `isPartOfIdentity` is explicitly false; it should also fail when `isPartOfIdentity` is true but the mapping path is not present in identityJsonPaths. Acceptance: (1) `isPartOfIdentity=true` must imply the mapping path (or at least one referenceJsonPath for a reference mapping) is present in `identityJsonPaths`; otherwise throw with an actionable message; (2) existing validation (identityJsonPaths present but isPartOfIdentity=false) continues to fail fast; (3) unit tests cover both directions for scalar/descriptor mappings and for reference mappings.",
    "steps-to-verify": [
      "Update `ResolveIsPartOfIdentity` in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtractInputsStep.cs` to throw when `isPartOfIdentity=true` but `identityJsonPaths` does not include the relevant path(s).",
      "Add unit tests in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/SchemaInputValidationTests.cs` for the new failure direction (both non-reference and reference cases).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Tests",
    "description": "Add a focused unit test asserting `TableConstraint.AllOrNoneNullability` is derived correctly for a reference group. Acceptance: (1) The derived table contains exactly one `AllOrNoneNullability` constraint per reference group (where identity columns are present); (2) `Name` matches `CK_{TableName}_{FkColumn}_AllOrNone`; (3) `FkColumn` matches the reference `..._DocumentId` column; (4) `DependentColumns` equals the propagated identity columns for that reference (correct names and deterministic order).",
    "steps-to-verify": [
      "Add a new test fixture (or extend existing) in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs` that asserts the `AllOrNoneNullability` constraint for a known reference (e.g., `SchoolReference`) has the expected `FkColumn` and dependent identity columns.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Performance",
    "description": "Tighten reference binding complexity by carrying an index map: `ReferenceBindingRelationalModelSetPass` currently does a list scan (`FindIndex`) to update concrete models. Refactor to precompute a `Dictionary<QualifiedResourceName, int>` (resource -> index) like the constraint pass does, and use it for updates. Acceptance: (1) No `FindIndex` usage remains in the pass; (2) behavior is unchanged for base resources and resource extensions; (3) reference binding remains deterministic and all unit tests pass.",
    "steps-to-verify": [
      "Refactor `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ReferenceBindingRelationalModelSetPass.cs` to use a resource->index map for updates.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Refactor",
    "description": "Review and remove helper duplication: `IsPrefixOf` exists in multiple passes (e.g., `ReferenceBindingRelationalModelSetPass` and `ConstraintDerivationRelationalModelSetPass`). Consolidate into a single shared helper (e.g., in `RelationalModelSetSchemaHelpers`) and update callers. Acceptance: (1) only one implementation exists in the codebase for JSONPath prefix checks; (2) callers use the shared helper; (3) behavior remains identical (all unit tests pass); (4) no new ordering/determinism regressions are introduced.",
    "steps-to-verify": [
      "Move/merge prefix-check logic into a shared helper and update call sites in both passes.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Refactor",
    "description": "Extract a shared WalkSchema context record to eliminate the 17-parameter explosion in ExtensionTableDerivationRelationalModelSetPass.WalkSchema. Bundle stable per-walk parameters (extensionProject, baseRootBaseName, extensionRootBaseName, baseTablesByScope, identityPaths, referenceIdentityPaths, referenceObjectPaths) into a `readonly record struct ExtensionWalkContext`. Pass one context object + the per-call mutation targets. Acceptance: (1) WalkSchema, WalkObjectSchema, and WalkArraySchema each accept <= 10 parameters; (2) no behavioral change — all existing unit tests pass; (3) the context record is immutable (readonly record struct or sealed record with init-only properties).",
    "steps-to-verify": [
      "Introduce `ExtensionWalkContext` in ExtensionTableDerivationRelationalModelSetPass.cs and refactor WalkSchema/WalkObjectSchema/WalkArraySchema to use it.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Refactor",
    "description": "Consolidate duplicate TableBuilder and ExtensionTableBuilder into a single shared builder. ReferenceBindingRelationalModelSetPass.TableBuilder and ExtensionTableDerivationRelationalModelSetPass.ExtensionTableBuilder contain nearly identical column-collision detection and constraint accumulation logic. Extract a shared `TableColumnAccumulator` (or make one compose/inherit the other). Acceptance: (1) Only one implementation of column-collision detection exists; (2) both passes use the shared builder; (3) all unit tests pass with no behavioral change.",
    "steps-to-verify": [
      "Extract shared builder and update both ReferenceBindingRelationalModelSetPass and ExtensionTableDerivationRelationalModelSetPass to use it.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Robustness",
    "description": "Remove fallback levels 3-4 from ConstraintDerivationRelationalModelSetPass.ApplyArrayUniquenessConstraint (lines 336-468). Analysis: Level 1 (direct scope match) handles the standard case where constraint scope matches table JsonScope directly. Level 2 (strip _ext.{project} prefix) is required for the cross-boundary nested constraint pattern — e.g. the contacts extension has basePath=$._ext.sample.addresses[*] with paths=[$.periods[*].beginDate], which resolves to scope $._ext.sample.addresses[*].periods[*], but the actual table is the base ContactAddressPeriod with scope $.addresses[*].periods[*]; stripping _ext.sample makes this match. Levels 3-4 (brute-force scan across ALL tables) are not exercised by any real Ed-Fi schema (ds-5.2 or sample). They catch InvalidOperationException per-candidate and silently continue, meaning if a table happens to have columns with matching names at the wrong scope, the constraint lands on the wrong table — violating the story AC 'no silent omissions'. Recommendation: Remove levels 3-4 and fail fast after level 2 with a diagnostic error citing the unmatched scope. Add a code comment on level 2 documenting the cross-boundary pattern it handles.",
    "steps-to-verify": [
      "Remove the two TryResolveArrayUniquenessTable brute-force blocks (levels 3-4, approx lines 400-443) from ApplyArrayUniquenessConstraint.",
      "After level 2 fails, throw immediately with a diagnostic message citing the unmatched scope.",
      "Add a code comment on level 2 explaining the cross-boundary extension constraint pattern (contacts/addresses/periods example).",
      "Verify all existing tests still pass — no real schema exercises levels 3-4.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Robustness",
    "description": "Remove the redundant Order property from IRelationalModelSetPass and all pass implementations. The canonical pass ordering is already determined by array position in RelationalModelSetPasses.CreatePasses(). The Order property is a second source of truth that can get out of sync. Acceptance: (1) Order property removed from the interface and all implementations; (2) no ordering validation needed since array position IS the order; (3) all unit tests pass.",
    "steps-to-verify": [
      "Remove Order from IRelationalModelSetPass interface.",
      "Remove Order property from all pass implementations (BaseTraversalAndDescriptorBindingRelationalModelSetPass, ExtensionTableDerivationRelationalModelSetPass, AbstractIdentityTableDerivationRelationalModelSetPass, ReferenceBindingRelationalModelSetPass, ConstraintDerivationRelationalModelSetPass).",
      "Remove any references to Order in pipeline runner or tests.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Performance",
    "description": "Cache GetAllDescriptorPathsForResource in RelationalModelSetBuilderContext. The method builds a merged dictionary from base + extension descriptor paths on every call. During constraint derivation this may be called repeatedly for the same resource. Acceptance: (1) The merged result is cached per resource (similar to GetOrCreateBuilderContext); (2) no behavioral change — all unit tests pass; (3) cache is lazily populated and not invalidated (descriptor paths are immutable after extraction).",
    "steps-to-verify": [
      "Add a Dictionary<QualifiedResourceName, ...> cache field in RelationalModelSetBuilderContext and populate it lazily in GetAllDescriptorPathsForResource.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Robustness",
    "description": "Standardize string comparison to Ordinal. ExtensionTableDerivationRelationalModelSetPass uses StringComparison.OrdinalIgnoreCase in some places but StringComparer.Ordinal elsewhere. The design docs specify PascalCase naming, so case-insensitive comparison could mask naming bugs (e.g., accepting 'school' where 'School' is expected). Acceptance: (1) All string comparisons in the relational model derivation passes use StringComparer.Ordinal / StringComparison.Ordinal unless there is a documented reason for case-insensitivity; (2) any intentional case-insensitive comparisons are annotated with a comment explaining why; (3) all unit tests pass.",
    "steps-to-verify": [
      "Grep for OrdinalIgnoreCase in all relational model pass files and evaluate each usage.",
      "Replace with Ordinal or add justification comment for each.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Robustness",
    "description": "Move column collision detection from Build() to AddColumn() time in TableBuilder and ExtensionTableBuilder. Currently duplicate columns are only detected when Build() is called, meaning the error is reported far from the code that introduced the duplicate. Acceptance: (1) AddColumn (or equivalent) throws immediately when a duplicate column name is added, with context about the conflicting source; (2) Build() no longer needs separate collision detection; (3) all unit tests pass.",
    "steps-to-verify": [
      "Update AddColumn in both TableBuilder and ExtensionTableBuilder to throw on duplicate column names at insertion time.",
      "Remove redundant collision checks from Build().",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Correctness",
    "description": "Add identity nullability guardrails. Identity components (identityJsonPaths) should not map to nullable columns, otherwise the root UNIQUE constraint can be weakened by NULL semantics. For reference-sourced identity components, enforce that the reference is required (isRequired=true) so the corresponding `..._DocumentId` FK column is NOT NULL. Acceptance: (1) If an identityJsonPath maps to a nullable scalar/descriptor column, fail fast with an actionable error; (2) If a document reference contributes to identity but isRequired=false, fail fast; (3) Add unit tests proving these fail-fast rules; (4) All existing unit tests pass.",
    "steps-to-verify": [
      "Add/extend unit tests that define an identityJsonPath on an optional (or x-nullable) scalar property and assert compilation fails with a clear message.",
      "Add/extend unit tests that define a reference identity component (isPartOfIdentity=true) with isRequired=false and assert compilation fails with a clear message.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Robustness",
    "description": "Fail fast on duplicate reference identity bindings instead of selecting a winner. `BuildReferenceIdentityColumns` currently de-dupes duplicate mappings by selecting the lexicographically smaller path/column, which can silently mask upstream ApiSchema issues. Acceptance: (1) If `documentPathsMapping.referenceJsonPaths` contains duplicate identityJsonPath entries for a single reference mapping, fail fast with an actionable message; (2) If derived `DocumentReferenceBinding.IdentityBindings` contains duplicates for the same referenceJsonPath, fail fast; (3) Add unit tests for these fail-fast conditions; (4) All existing unit tests pass.",
    "steps-to-verify": [
      "Update `ConstraintDerivationRelationalModelSetPass.BuildReferenceIdentityColumns` to throw on duplicates rather than selecting the smallest by string comparison.",
      "Add unit tests constructing ApiSchema fixtures with duplicate referenceJsonPaths entries and assert compilation fails with a clear message.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  }
]
