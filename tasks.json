[
  {
    "category": "Refactor",
    "description": "DMS-931: Refactor constraint derivation to separate logical constraint identity from physical constraint name (internal-only) so DMS-931 can safely rewrite physical identifiers later. Acceptance: (1) All internal “already exists”/dedupe checks for FK/UK/CK constraints are based on semantic identity (kind + owning table + ordered local columns + target table/columns + referential actions) rather than string names; (2) no derivation pass relies on the current physical name being final; (3) the public `DerivedRelationalModelSet` contract remains unchanged (still carries only final physical names); (4) unit tests demonstrate dedupe/contain behavior remains correct after a renaming pass rewrites physical names.",
    "steps-to-verify": [
      "Introduce an internal constraint identity/signature representation and update constraint-related helpers (e.g., `ConstraintDerivationHelpers.Contains*`) and passes to use semantic identity instead of `Name` strings.",
      "Ensure all constraint emission still sets *some* physical name before the model is finalized, but treat it as rewriteable by DMS-931 passes.",
      "Add/adjust unit tests to prove constraints are not duplicated when physical names change (e.g., run the naming/shortening pass and assert constraint counts/semantics are stable).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Naming",
    "description": "DMS-931: Replace verbose constraint naming (`UX_{Table}_{Col1}_{Col2}_...`, `FK_{Table}_{Col1}_{Col2}_...`) with purpose-based names that avoid repeating shared reference prefixes, and append `_{h10}` (first 10 hex of SHA-256 of a canonical constraint signature) only when the resulting name would exceed the target dialect identifier limit (Pgsql 63 bytes, Mssql 128 chars). Acceptance: (1) FK/UK/CK names are derived from the owning table plus stable role tokens (e.g., reference base name, `NK`, `RefKey`, `AllNone`) instead of concatenating the full physical column list; (2) composite reference FKs use a single reference token (no `ReferenceBaseName_` duplication per column); (3) `h10` is present only when required by the dialect max length; otherwise the name contains no hash suffix; (4) hashing uses a canonical signature string that includes at least kind, owning table, ordered local columns, target table, ordered target columns, and referential actions so it is deterministic and collision-resistant; (5) names are deterministic and stable across runs; (6) names are unique post-shortening (collisions fail fast with structured collision records); (7) update the authoritative expected outputs so the unique constraint currently at `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/authoritative/sample/expected/authoritative-derived-relational-model-set.json:2456` and the FK at `...:2630` no longer contain duplicated reference prefixes and are within the Pgsql limit; (8) unit tests cover within-limit (no hash) and over-limit (hash) cases for both FK and UK naming.",
    "steps-to-verify": [
      "Introduce a constraint naming service/helper that generates a short, semantic base name per constraint kind/purpose and only appends `_{h10}` when the dialect max identifier length would be exceeded.",
      "Update all constraint derivation code to use the new naming strategy (FK/UK/CK, including all-or-none checks) and to avoid embedding repeated reference prefixes.",
      "Update `reference/design/backend-redesign/design-docs/data-model.md` constraint naming section to match the implemented strategy (purpose tokens + optional length-driven `h10`).",
      "Update the authoritative expected fixture outputs and add unit tests asserting the example constraints no longer repeat reference prefixes and that `h10` is absent when the base name is within the dialect limit.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Naming",
    "description": "DMS-931: Implement `resourceSchema.relational.rootTableNameOverride` and ensure the root base name flows through *all* derived artifacts. Acceptance: (1) `rootTableNameOverride` is normalized via `RelationalNameConventions.ToPascalCase` and must be non-empty after normalization; (2) it affects everything derived from the root base name: root table, child table names, `{RootBaseName}_DocumentId` key-part columns, extension table prefixes `{RootBaseName}Extension*`, abstract identity table/view names, and constraint/index/trigger naming tokens derived from table/column names; (3) `rootTableNameOverride` on `isResourceExtension:true` schemas fails fast; (4) any `relational` block on `isDescriptor:true` resources fails fast (descriptor resources still allow overrides on descriptor *references* via their JSONPaths in non-descriptor resources); (5) behavior is deterministic and covered by unit tests.",
    "steps-to-verify": [
      "Update `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtractInputsStep.cs` to extract/validate `relational.rootTableNameOverride` and to fail fast on descriptor resources and resource-extension schemas as specified.",
      "Implement a DMS-931 naming pass that rewrites the derived model’s root base name and all dependent identifiers consistently (tables, key columns, abstract artifacts, extension artifacts).",
      "Add unit tests using hand-authored fixtures that assert rootTableNameOverride changes child table names and key-part column names deterministically.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Naming",
    "description": "DMS-931: Implement full `resourceSchema.relational.nameOverrides` semantics (beyond DMS-930 placeholders) and remove temporary restrictions. Acceptance: (1) Override keys are parsed and canonicalized using the restricted JSONPath grammar (`$`, `.prop`, `[*]` only); (2) override values are normalized with `RelationalNameConventions.ToPascalCase` and must be non-empty after normalization; (3) known keys are limited to derived columns and array table scopes (including elements under `_ext`); unknown keys fail fast with diagnostics that include both raw key text and canonical form plus owning resource; (4) scalar overrides replace the entire computed column base name (including inlined prefixes), not just the leaf; (5) reference overrides at the reference object path rename *all* reference artifacts (FK `..._DocumentId`, propagated identity columns, and any constraint/index/trigger names that include those physical names); “inside reference object” keys (e.g., `$.studentReference.studentUniqueId`) are invalid and fail fast; (6) array overrides are suffix-only full collection suffixes: `$.a[*].b[*]` override must start with the effective suffix for `$.a[*]`, and the ordinal key-part column names are derived from the remainder segment (override applies to ordinal naming too); (7) if any ancestor collection has an override, *all descendant* collection scopes must have explicit overrides, otherwise fail fast; (8) extension resource schemas (`isResourceExtension:true`) may specify `relational.nameOverrides` only (no `rootTableNameOverride`), supporting both relative keys and fully-qualified `$._ext.{projectKey}...` keys; relative keys are auto-prefixed to `$._ext.{resolvedProjectKey}...` using the exact key found in the base resource schema’s `_ext` site (case-sensitive match); (9) fail fast when a base resource override and an extension schema override target the same canonical derived element; (10) collisions introduced by overrides fail fast with structured collision records.",
    "steps-to-verify": [
      "Replace the DMS-930 placeholder override extraction in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/ExtractInputsStep.cs` so all overrides are captured for DMS-931 and reference-only restrictions are removed.",
      "Implement restricted-JSONPath override parsing/validation and apply overrides to derived identifiers at the correct stage (before suffixes like `_DocumentId`/`_DescriptorId` and before dialect shortening).",
      "Add unit tests (hand-authored fixtures) covering: scalar override (including inlined objects), reference override, array override + remainder ordinal naming, recursive descendant override requirement, unknown key diagnostics (raw + canonical), inside-reference-object key failure, extension-schema override auto-prefixing, and base-vs-extension override conflict failure.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": false
  },
  {
    "category": "Naming",
    "description": "DMS-931: Implement deterministic collision detection with a structured “collision record” format for naming/overrides/shortening. Acceptance: (1) Collision diagnostics always answer what collided (identifier kind), where (schema/table and owning resource + JSONPath where applicable), and why (stage + pre→post mapping); (2) stages are explicit (e.g., `AfterSchemaNormalization`, `AfterOverrideNormalization`, `AfterDialectShortening(Pgsql:63-bytes)`); (3) collision records are formatted deterministically (stable ordering) and include both pre- and post-normalization/shortening identifiers; (4) override collisions and shortening collisions both use the same record model; (5) unit tests assert deterministic formatting for at least one collision scenario.",
    "steps-to-verify": [
      "Introduce collision record types + deterministic formatter, and update/replace `IdentifierCollisionDetector` so collisions can report stage and pre→post mapping.",
      "Use the collision record format for: override-induced collisions, dialect-shortening collisions, and any other fail-fast naming collisions introduced by DMS-931.",
      "Add unit tests that assert collision diagnostics include kind + location + stage + pre→post mapping and are deterministically ordered.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Naming",
    "description": "DMS-931: Apply dialect identifier shortening into the derived model (not just collision detection), including schema names. Today `RelationalModelSetBuilderContext.BuildResult` detects shortening collisions, but the model still stores pre-shortened identifiers, forcing every downstream consumer to remember to shorten consistently. Acceptance: (1) A set-level pass rewrites *all* derived identifiers using `context.DialectRules.ShortenIdentifier` and stores the shortened names in the `DerivedRelationalModelSet` (schemas, tables, columns, constraints, indexes, triggers, abstract identity tables/views); (2) all internal references are updated consistently (FK `TargetTable/TargetColumns`, `DocumentReferenceBinding.Table/FkColumn/IdentityBindings`, `DescriptorEdgeSource`, index/trigger `Table/KeyColumns`, etc.); (3) the pass is deterministic and idempotent (running twice yields the same model); (4) collision detection still fails fast when multiple original identifiers shorten to the same value, using the structured collision record format; (5) unit tests cover overlong table/column/constraint/index/trigger/schema names and assert the shortened identifiers are present in the output and referenced correctly; (6) all unit tests pass and the DMS solution builds.",
    "steps-to-verify": [
      "Implement a new set-level pass (e.g., `ApplyDialectIdentifierShorteningRelationalModelSetPass`) that rewrites identifiers in-place on `RelationalModelSetBuilderContext` inventories using `DialectRules.ShortenIdentifier` and updates all references consistently (including `ProjectSchemasInEndpointOrder[*].PhysicalSchema`).",
      "Register the pass in `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/RelationalModelSetPasses.cs` after the DMS-931 naming/override/constraint-naming pass and before `CanonicalizeOrderingRelationalModelSetPass`.",
      "Add unit tests that force overlong identifiers (including schema names) and assert the shortened names are stored in the resulting `DerivedRelationalModelSet` and referenced correctly by constraints/bindings/inventories. Include at least one Pgsql (63-byte) and one Mssql (128-char) case.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Testing",
    "description": "DMS-931: Add “naming-stress” hand-authored fixtures + extend authoritative expected outputs (inputs unchanged). Acceptance: (1) New unit tests are built from `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/set-builder/*` fixtures and exercise: long names, `rootTableNameOverride`, scalar/reference/array overrides (including nested-array remainder ordinal naming and recursive descendant override enforcement), extension-schema override auto-prefixing, reserved-word/edge-case normalization, and collision diagnostics; (2) authoritative fixture inputs remain unchanged; only `expected/` outputs are updated to reflect new naming/override/constraint-naming/shortening behavior; (3) the authoritative derived model set JSON comparisons pass; (4) the DMS solution builds.",
    "steps-to-verify": [
      "Add/extend hand-authored fixture inputs under `./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/Fixtures/set-builder/` to cover naming stress scenarios without requiring changes to authoritative inputs.",
      "Update authoritative `expected/authoritative-derived-relational-model-set.json` files to match the new deterministic naming + constraint naming + shortening behavior.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  }
]
