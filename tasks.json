[
  {
    "category": "Contracts",
    "description": "Introduce synthetic presence hardening via `TableConstraint.NullOrTrue`. Acceptance: `src/dms/backend/EdFi.DataManagementService.Backend.External/RelationalModelTypes.cs` defines `TableConstraint.NullOrTrue(string Name, DbColumnName Column)`; `ConstraintIdentity`/`ConstraintNaming`/`ApplyConstraintDialectHashingPass`/`ApplyDialectIdentifierShorteningPass`/`RelationalModelOrdering` support this new constraint kind; `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelManifestEmitter.cs` serializes it deterministically; and `src/dms/backend/EdFi.DataManagementService.Backend.Ddl/RelationalModelDdlEmitter.cs` emits a dialect-appropriate CHECK expression (`<col> IS NULL OR <col> = TRUE/1`) so DDL unit tests stay green.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.Ddl.Tests.Unit/EdFi.DataManagementService.Backend.Ddl.Tests.Unit.csproj`",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Key Unification",
    "description": "Align `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs` to `reference/design/backend-redesign/design-docs/key-unification.md`: resolve equality-constraint endpoints strictly by exact `DbColumnModel.SourceJsonPath.Canonical` match (delete `FindReferenceRelativeAliasCandidates` and `TryResolveAmbiguousReferenceEndpoint` heuristics), fail fast on unresolved/ambiguous endpoints and unsupported endpoint kinds (only `Scalar` and `DescriptorFk`), classify every `resourceSchema.equalityConstraints` entry deterministically as `applied`/`redundant`/`ignored(cross_table)` for manifest emission, and build per-table connected components for `applied` edges. For each same-table unification class: add exactly one canonical stored column (`SourceJsonPath=null`), convert each member path column to `ColumnStorage.UnifiedAlias(canonical, presence?)`, gate reference-identity members by `{RefBaseName}_DocumentId`, gate optional non-reference members by synthetic nullable-boolean `{MemberColumn}_Present` (stored, `SourceJsonPath=null`) + one `TableConstraint.NullOrTrue` hardening CHECK per synthetic presence column, and leave required non-reference members ungated. Acceptance: `DbTableModel.KeyUnificationClasses` is populated with stable ordering (class order + member order) and no FK references any `UnifiedAlias` or synthetic presence-flag columns.",
    "steps-to-verify": [
      "Add/extend unit tests in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/KeyUnificationPassTests.cs` for strict endpoint resolution (unresolved/ambiguous), applied/redundant/ignored classification, reference-site gating via `..._DocumentId`, and optional scalar/descriptor gating via synthetic `..._Present` + `NullOrTrue`.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Descriptor FKs",
    "description": "Refactor descriptor FK constraint emission into a post-unification set-level pass. Acceptance: remove early descriptor FK constraint creation in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceBindingPass.cs` and `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ExtensionTableDerivationPass.cs`; add a new pass (wired into `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelSetPasses.cs` after `KeyUnificationPass` and before any constraint hashing/shortening) that maps each descriptor binding column (`ColumnKind.DescriptorFk`) to its storage column via `DbColumnModel.Storage` (canonical when unified), emits exactly one FK to `dms.Descriptor(DocumentId)` per `(table, storage_column)` pair, and records deterministic `descriptor_fk_deduplications[]` diagnostics when multiple binding columns map to the same storage column; constraint names are derived from `(table, storage_column)` so they are stable under de-dup.",
    "steps-to-verify": [
      "Add a unit test where two descriptor binding columns unify to one canonical storage column and assert only one descriptor FK constraint exists and `ValidateForeignKeyStorageInvariantPass` remains satisfied.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Reference Constraints",
    "description": "Update (or validate) `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ReferenceConstraintPass.cs` behavior under unification. Acceptance: composite reference FKs map both local and target identity-part columns through `DbColumnModel.Storage` (via `UnifiedAliasStorageResolver`) and de-duplicate repeated canonical storage columns after mapping while preserving `identityJsonPaths` order; FK-supporting referenced-key UNIQUE constraints use the mapped (and de-duplicated) target storage columns; and all-or-none CHECK constraints remain on binding/path columns (including aliases) + `..._DocumentId` (no storage mapping).",
    "steps-to-verify": [
      "Add/extend unit tests in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/ConstraintDerivationRelationalModelSetPassTests.cs` that exercise identity-part unification causing duplicate storage columns and assert FK/UK dedup with stable ordering.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Dialect Shortening",
    "description": "Fix dialect shortening for key unification metadata. Acceptance: `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ApplyDialectIdentifierShorteningPass.cs` rewrites all key-unification references when identifiers shorten: `ColumnStorage.UnifiedAlias` pointers (canonical/presence), `DbTableModel.KeyUnificationClasses` (canonical + member lists), and `TableConstraint.NullOrTrue.Column`; plus any manifest diagnostics structures that store column names (if they are persisted across passes). Add unit tests covering shortening rewrites for both Pgsql and Mssql identifier limits.",
    "steps-to-verify": [
      "Add unit tests for identifier shortening rewriting of unified-alias pointers, key-unification classes, and `NullOrTrue` constraints.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Ordering",
    "description": "Fix deterministic ordering to respect unified-alias dependencies. Acceptance: canonical ordering guarantees the alias-dependency invariant (for every `UnifiedAlias`, its canonical and presence columns—including reference-site `..._DocumentId` and synthetic `..._Present`—appear earlier in `DbTableModel.Columns`), and places key-unification support columns (canonicals + synthetic presence flags) before dependent aliases while keeping existing key/descriptor/scalar grouping stable when possible; constraint ordering includes `NullOrTrue` deterministically (stable group + secondary name sort).",
    "steps-to-verify": [
      "Add unit tests for column-order dependency invariants (canonical/presence precede aliases) and for deterministic constraint ordering including `NullOrTrue`.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Manifests",
    "description": "Emit key-unification diagnostics in manifest JSON (per `reference/design/backend-redesign/design-docs/key-unification.md`) without changing the public `DerivedRelationalModelSet` contract surface beyond the existing key-unification metadata. Acceptance: `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/Build/RelationalModelManifestEmitter.cs` emits `key_unification_equality_constraints` and always includes it (empty arrays when none): `applied`/`redundant`/`ignored` plus `ignored_by_reason`; endpoint paths are canonicalized to undirected `(minPath,maxPath)` ordering while preserving duplicate ApiSchema entries; ignored.reason supports only `cross_table`; applied entries include resolved endpoint binding columns and the final `canonical_column`. Also emit per-table `descriptor_fk_deduplications` always present (empty when none) with deterministic ordering and including `constraint_name` for each de-dup group. Ensure `NullOrTrue` constraints serialize deterministically in `constraints[]`.",
    "steps-to-verify": [
      "Update `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelManifestEmitterTests.cs` to assert new properties exist and are empty when appropriate.",
      "Add a focused minimal-schema test that produces applied/redundant/cross_table cases and asserts the emitted report shape and ordering.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Goldens",
    "description": "Update authoritative DS 5.2 fixtures/goldens to validate end-to-end set-level behavior. Acceptance: `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/RelationalModelAuthoritativeGoldenTests.cs` switches from the per-resource pipeline to the set-level `DerivedRelationalModelSetBuilder` so reference binding + key unification + descriptor FK de-dup + diagnostics execute; `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/DerivedRelationalModelSetAuthoritativeGoldenTests.cs` includes `Ed-Fi.StudentAssessmentRegistration` and `Ed-Fi.ProgramEvaluationElement` in `resource_details` for key-unification coverage; goldens pass without `UPDATE_GOLDENS`, and no `RelationalMappingVersion` bump is introduced (fixtures may remain on existing version strings such as `1.0.0`).",
    "steps-to-verify": [
      "Regenerate goldens once: `UPDATE_GOLDENS=1 dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Verify clean diff: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`"
    ],
    "completed": true
  },
  {
    "category": "Docs",
    "description": "Update mapping-pack/proto surfaces in design docs only (no new in-repo .proto project). Acceptance: `reference/design/backend-redesign/design-docs/mpack-format-v1.md` updates `TableConstraint` to cover `AllOrNoneNullability`, `NullOrTrue`, and FK referential actions (on_delete/on_update) while keeping existing key-unification payload additions (`DbColumnModel.storage`, `DbTableModel.key_unification_classes`, write-plan precomputed + key-unification plans); docs reflect that this repo is not bumping `RelationalMappingVersion` yet.",
    "steps-to-verify": [
      "Review doc diff: `git diff -- reference/design/backend-redesign/design-docs/mpack-format-v1.md`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Key Unification",
    "description": "Fix fail-fast ambiguity handling ordering in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs` so ambiguous/unresolved endpoints cannot be silently downgraded to `ignored(cross_table)`. Acceptance: for each equality-constraint endpoint, enforce the authoritative resolution rules in `reference/design/backend-redesign/design-docs/key-unification.md` before any cross-table classification: (1) resolve candidates strictly by exact `DbColumnModel.SourceJsonPath.Canonical` match, (2) de-duplicate only when all candidates are the same `(table,column)` binding, (3) fail fast when candidate count is 0 or >1 after de-dup, (4) validate supported endpoint kinds (`Scalar`, `DescriptorFk`) on the uniquely resolved bindings, and only then (5) classify as `ignored(cross_table)` when both endpoints resolve uniquely but bind to different physical tables.",
    "steps-to-verify": [
      "Add a unit test in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/KeyUnificationPassTests.cs` where a cross-table equality constraint endpoint is also ambiguous (duplicate `SourceJsonPath` bindings across different tables) and assert the derived-model build fails fast (no `ignored(cross_table)` classification).",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Key Unification",
    "description": "Remove foreign key mutation from key unification and replace it with a set-level invariant. Acceptance: delete `RewriteForeignKeyColumnsToStorage` (and helper `ResolveForeignKeyStorageColumn`) from `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs` so the pass no longer rewrites any pre-existing PK/UK/FK/all-or-none constraints (per `reference/design/backend-redesign/design-docs/key-unification.md`, step 9). Enforce the contract via `ValidateForeignKeyStorageInvariantPass` (or a new invariant pass): fail fast deterministically if any FK local or target column is a `ColumnStorage.UnifiedAlias` or a synthetic `..._Present` presence-flag column, and ensure the diagnostic includes constraint name, table, and offending column(s).",
    "steps-to-verify": [
      "Add/extend unit tests that exercise an FK referencing an alias column and assert the invariant pass fails fast with an actionable message.",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Contracts",
    "description": "Make `DbColumnModel.Storage` a positional record component to match the `reference/design/backend-redesign/design-docs/key-unification.md` contract and avoid equality/deconstruction footguns. Acceptance: update `src/dms/backend/EdFi.DataManagementService.Backend.External/RelationalModelTypes.cs` so `DbColumnModel` primary constructor includes `ColumnStorage Storage`, preserving a backwards-compatible constructor that defaults `Storage` to `new ColumnStorage.Stored()` for existing call sites. Ensure `record` equality, `Deconstruct`, and `with`-expressions all include `Storage`, and update all call sites/serializers accordingly so unit tests and goldens remain green.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.Ddl.Tests.Unit/EdFi.DataManagementService.Backend.Ddl.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": true
  },
  {
    "category": "Key Unification",
    "description": "Remove the dead/pointless branch in `ResolveCanonicalBaseName` in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs`. Acceptance: either simplify to the spec behavior (canonical base token is deterministically the first ordered member’s base token per `reference/design/backend-redesign/design-docs/key-unification.md`) without allocating/validating unused token arrays, or implement a meaningful divergent rule with explicit unit tests; current behavior must not remain as an indistinguishable conditional.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Key Unification",
    "description": "Eliminate redundant sorting and allocations in connected-component ordering in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/KeyUnificationPass.cs`. Acceptance: remove the second per-component `OrderBy(...)` inside `string.Join(\"|\", ...)` since components are already sorted by `BuildConnectedComponents`, and replace the `string.Join` sorting key with a clearer/cheaper deterministic comparer (e.g., compare by first element then length then sequence) so ordering remains stable without unnecessary string allocations.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Refactoring",
    "description": "Consolidate FK validation logic to a single authoritative implementation. Acceptance: remove or refactor the duplicate FK-column validation currently implemented in both `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ValidateForeignKeyStorageInvariantPass.cs` and `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/DeriveIndexInventoryPass.cs` by extracting a shared validator (or by relying solely on the invariant pass with explicit pass-ordering guarantees). Ensure both local and target column validation consistently rejects `UnifiedAlias` columns and synthetic presence-flag columns, and that error messages remain deterministic and actionable.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  },
  {
    "category": "Dialect Shortening",
    "description": "Simplify UnifiedAlias change detection in `src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel/SetPasses/ApplyDialectIdentifierShorteningPass.cs`. Acceptance: replace the current multi-branch `changed` computation for `ColumnStorage.UnifiedAlias` with an equivalent expression that is easier to audit, e.g. `changed = !updatedCanonicalColumn.Equals(unifiedAlias.CanonicalColumn) || !Nullable.Equals(updatedPresenceColumn, unifiedAlias.PresenceColumn)`, and ensure behavior is unchanged via unit tests/goldens.",
    "steps-to-verify": [
      "Run: `dotnet test --no-restore ./src/dms/backend/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit/EdFi.DataManagementService.Backend.RelationalModel.Tests.Unit.csproj`",
      "Run: `dotnet build --no-restore ./src/dms/EdFi.DataManagementService.sln`"
    ],
    "completed": false
  }
]
