### OAuth Token Info Endpoint - Complete Test Flow
### This file demonstrates the complete flow from API client creation to token introspection
###
### PREREQUISITES:
### 1. Start local DMS environment with your preferred identity provider:
###
###    For SELF-CONTAINED OpenIddict:
###    cd eng/docker-compose
###    .\start-local-dms.ps1 -EnableConfig -EnableSwaggerUI -r -IdentityProvider self-contained -EnvironmentFile .env -LoadSeedData
###
###    For KEYCLOAK:
###    cd eng/docker-compose
###    .\start-local-dms.ps1 -EnableConfig -EnableSwaggerUI -r -IdentityProvider keycloak -EnvironmentFile .env.keycloak -LoadSeedData
###
### 2. Wait for services to be ready (DMS on port 8080, Config on port 8081)
###
### 3. Set the identity provider below (comment/uncomment the appropriate section)
###
### 4. Run requests sequentially by clicking "Send Request" above each block
###
### NOTE: If you get "DMS instance X not found" errors in token_info responses, ensure:
###   - The DMS instance exists in the Config Service (GET /v2/dmsInstances)
###   - You've called /management/reload-schema after creating new instances
###   - Or use the seed data instance (ID 1) which is pre-loaded with -LoadSeedData

@dmsPort=8080
@configPort=8081
@sysAdminId=DmsConfigurationService
@sysAdminSecret=s3creT@09
@tokenScope=edfi_admin_api/full_access

###############################################################################
### IDENTITY PROVIDER CONFIGURATION
### Uncomment ONE section below based on your environment
###############################################################################

### ----- OPTION 1: Self-Contained OpenIddict (DEFAULT) -----
@identityProvider=self-contained
@tokenEndpoint=http://localhost:{{configPort}}/connect/token

### ----- OPTION 2: Keycloak -----
### Uncomment below and comment out Option 1 above to use Keycloak
# @identityProvider=keycloak
# @tokenEndpoint=http://localhost:{{keycloakPort}}/realms/{{keycloakRealm}}/protocol/openid-connect/token

###############################################################################
### STEP 1: Authenticate as System Admin
###############################################################################

### Create Configuration Service admin token
### This request works for both self-contained and Keycloak
# @name configTokenRequest
POST {{tokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

client_id={{sysAdminId}}
&client_secret={{sysAdminSecret}}
&grant_type=client_credentials
&scope={{tokenScope}}

### Extract the admin token
@configToken={{configTokenRequest.response.body.access_token}}

###############################################################################
### STEP 2: Create Vendor
###############################################################################

### Create a new vendor for testing
# @name createVendor
POST http://localhost:{{configPort}}/v2/vendors
Content-Type: application/json
Authorization: bearer {{configToken}}

{
    "company": "Token Info Test Vendor {{$randomInt 0 9999999}}",
    "contactName": "Test User",
    "contactEmailAddress": "test@example.com",
    "namespacePrefixes": "uri://ed-fi.org"
}

### Extract vendor ID
@vendorId={{createVendor.response.body.id}}

###############################################################################
### STEP 3: Create DMS Instance
###############################################################################

### Create a DMS instance for testing
# @name createDmsInstance
POST http://localhost:{{configPort}}/v2/dmsInstances
Content-Type: application/json
Authorization: bearer {{configToken}}

{
    "instanceType": "Test",
    "instanceName": "Token Info Test Instance",
    "connectionString": "host=dms-postgresql;port=5432;username=postgres;password=abcdefgh1!;database=edfi_datamanagementservice;"
}

### Extract DMS instance ID
@dmsInstanceId={{createDmsInstance.response.body.id}}


###############################################################################
### STEP 4: Create API Client with Multiple Education Organizations
###############################################################################

### Create application with SIS Vendor claim set and multiple EdOrgs
# @name createApplication
POST http://localhost:{{configPort}}/v2/applications
Content-Type: application/json
Authorization: bearer {{configToken}}

{
    "vendorId": {{vendorId}},
    "applicationName": "Token Info Test App {{$randomInt 0 9999}}",
    "claimSetName": "EdFiSandbox",
    "educationOrganizationIds": [255901, 255902, 255950],
    "dmsInstanceIds": [1]
}

### Extract client credentials
@clientId={{createApplication.response.body.key}}
@clientSecret={{createApplication.response.body.secret}}

###############################################################################
### STEP 5: Verify Authorization Metadata
###############################################################################

### Check what the SIS Vendor claim set includes
GET http://localhost:{{configPort}}/authorizationMetadata?claimSetName=EdFiSandbox
Authorization: bearer {{configToken}}

###############################################################################
### STEP 6: Generate Access Token for API Client
###############################################################################

### Get access token for the API client
# @name clientTokenRequest
POST {{tokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

client_id={{clientId}}
&client_secret={{clientSecret}}
&grant_type=client_credentials

### Extract the client access token
@clientToken={{clientTokenRequest.response.body.access_token}}

###############################################################################
### STEP 7: Test Token Info Endpoint (JSON Format)
###############################################################################

### Call token_info endpoint with JSON body
# @name tokenInfoJson
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/json
Authorization: bearer {{clientToken}}

{
    "token": "{{clientToken}}"
}

###############################################################################
### STEP 8: Test Token Info Endpoint (Form-Encoded Format)
###############################################################################

### Call token_info endpoint with form-encoded body (RFC 7662 standard)
# @name tokenInfoForm
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/x-www-form-urlencoded
Authorization: bearer {{clientToken}}

token={{clientToken}}

###############################################################################
### STEP 9: Test with Different Claim Set (EdOrgs Only)
###############################################################################

### Create another application with a different claim set
# @name createEdOrgApp
POST http://localhost:{{configPort}}/v2/applications
Content-Type: application/json
Authorization: bearer {{configToken}}

{
    "vendorId": {{vendorId}},
    "applicationName": "EdOrg Only App {{$randomInt 0 9999}}",
    "claimSetName": "E2E-RelationshipsWithEdOrgsOnlyClaimSet",
    "educationOrganizationIds": [255901],
    "dmsInstanceIds": [{{dmsInstanceId}}]
}
###
@edOrgClientId={{createEdOrgApp.response.body.key}}
@edOrgClientSecret={{createEdOrgApp.response.body.secret}}

### Get token for EdOrg-only client
# @name edOrgTokenRequest
POST {{tokenEndpoint}}
Content-Type: application/x-www-form-urlencoded

client_id={{edOrgClientId}}
&client_secret={{edOrgClientSecret}}
&grant_type=client_credentials
###
@edOrgToken={{edOrgTokenRequest.response.body.access_token}}

### Check token info for EdOrg-only client (self-introspection)
### Note: Authorization header and request body must contain the SAME token
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/json
Authorization: bearer {{edOrgToken}}

{
    "token": "{{edOrgToken}}"
}

###############################################################################
### STEP 10: Error Cases - Token Mismatch (Authorization header vs body token)
###############################################################################

### Test: Authorization header token does NOT match body token (should fail with 401)
### This tests the self-introspection requirement
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/json
Authorization: bearer {{clientToken}}

{
    "token": "{{edOrgToken}}"
}

###############################################################################
### STEP 11: Error Cases - Missing Authorization Header
###############################################################################

### Test: Missing Authorization header (should fail with 401)
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/json

{
    "token": "{{clientToken}}"
}

###############################################################################
### STEP 12: Error Cases - Missing Body Token
###############################################################################

### Test: Authorization header present but no token in body (should fail with 401)
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/json
Authorization: bearer {{clientToken}}

{
}

###############################################################################
### STEP 13: Error Cases - Invalid Token Format
###############################################################################

### Test: Invalid token format (should fail with 401)
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/json
Authorization: bearer invalid-token-format

{
    "token": "invalid-token-format"
}

###############################################################################
### STEP 14: Error Cases - Expired Token (if available)
###############################################################################

### Note: To test expired token, you need to wait for token expiration
### or configure a short-lived token. This is typically tested in E2E tests.

### Test: Form-encoded with matching tokens (alternative format)
POST http://localhost:{{dmsPort}}/oauth/token_info
Content-Type: application/x-www-form-urlencoded
Authorization: bearer {{clientToken}}

token={{clientToken}}
