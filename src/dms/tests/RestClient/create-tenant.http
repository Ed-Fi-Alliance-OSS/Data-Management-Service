# Create a simple tenant in the Configuration Service
#
# Prerequisites:
# - Configuration Service running at localhost:8081 (or update configPort below)
# - System administrator credentials registered (run steps 1-2 if needed)

@configPort=8081
@sysAdminId=sys-admin
@sysAdminSecret=SdfH)98&Jk
@encodedSysAdminSecret=SdfH%2998%26Jk

### Step 1: Register system administrator (skip if already registered)
POST http://localhost:{{configPort}}/connect/register
Content-Type: application/x-www-form-urlencoded

ClientId={{sysAdminId}}
&ClientSecret={{encodedSysAdminSecret}}
&DisplayName=System Administrator

### Step 2: Get access token
# @name configTokenRequest
POST http://localhost:{{configPort}}/connect/token
Content-Type: application/x-www-form-urlencoded

client_id={{sysAdminId}}
&client_secret={{encodedSysAdminSecret}}
&grant_type=client_credentials
&scope=edfi_admin_api/full_access

###
@configToken={{configTokenRequest.response.body.access_token}}

### Step 3: Create Tenant1
POST http://localhost:{{configPort}}/v2/tenants/
Content-Type: application/json
Authorization: bearer {{configToken}}

{
    "name": "Tenant1"
}

### Step 4: Create Tenant2
POST http://localhost:{{configPort}}/v2/tenants/
Content-Type: application/json
Authorization: bearer {{configToken}}

{
    "name": "Tenant2"
}

### Step 5: Verify tenants were created
GET http://localhost:{{configPort}}/v2/tenants/
Authorization: bearer {{configToken}}

#############################################
# Tenant Segregation Demonstration
#############################################

### Step 6: Create DMS Instance for Tenant1
POST http://localhost:{{configPort}}/v2/dmsInstances
Content-Type: application/json
Authorization: bearer {{configToken}}
Tenant: Tenant1

{
    "instanceType": "Production",
    "instanceName": "Tenant1 Production",
    "connectionString": "Server=localhost;Database=Tenant1Prod;"
}

### Step 7: Create another DMS Instance for Tenant1
POST http://localhost:{{configPort}}/v2/dmsInstances
Content-Type: application/json
Authorization: bearer {{configToken}}
Tenant: Tenant1

{
    "instanceType": "Development",
    "instanceName": "Tenant1 Dev",
    "connectionString": "Server=localhost;Database=Tenant1Dev;"
}

### Step 8: Create DMS Instance for Tenant2
POST http://localhost:{{configPort}}/v2/dmsInstances
Content-Type: application/json
Authorization: bearer {{configToken}}
Tenant: Tenant2

{
    "instanceType": "Production",
    "instanceName": "Tenant2 Production",
    "connectionString": "Server=localhost;Database=Tenant2Prod;"
}

### Step 9: Query DMS Instances for Tenant1 (should return 2 instances)
GET http://localhost:{{configPort}}/v2/dmsInstances
Authorization: bearer {{configToken}}
Tenant: Tenant1

### Step 10: Query DMS Instances for Tenant2 (should return 1 instance)
GET http://localhost:{{configPort}}/v2/dmsInstances
Authorization: bearer {{configToken}}
Tenant: Tenant2


### Step 11: Query DMS Instances with missing Tenant header
GET http://localhost:{{configPort}}/v2/dmsInstances
Authorization: bearer {{configToken}}
