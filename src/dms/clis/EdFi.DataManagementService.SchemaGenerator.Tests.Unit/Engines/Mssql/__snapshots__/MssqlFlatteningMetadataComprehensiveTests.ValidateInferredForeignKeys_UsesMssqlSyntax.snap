-- Check if FK constraint FK_edfi_StudentAssessment_Assessment already exists
IF NOT EXISTS (
    SELECT 1 FROM sys.foreign_keys fk
    INNER JOIN sys.schemas s ON fk.schema_id = s.schema_id
    WHERE fk.name = 'FK_edfi_StudentAssessment_Assessment'
    AND s.name = 'dms'
)
BEGIN
    -- Verify referenced table exists
    IF EXISTS (
        SELECT 1 FROM sys.tables t
        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
        WHERE t.name = 'edfi_Assessment'
        AND s.name = 'dms'
    )
    BEGIN
        ALTER TABLE [dms].[edfi_StudentAssessment]
        ADD CONSTRAINT [FK_edfi_StudentAssessment_Assessment]
        FOREIGN KEY ([Assessment_Id])
        REFERENCES [dms].[edfi_Assessment]([Id]);

        PRINT 'Created FK constraint: FK_edfi_StudentAssessment_Assessment';
    END
    ELSE
        PRINT 'Skipped FK constraint FK_edfi_StudentAssessment_Assessment: Referenced table does not exist';
END
ELSE
    PRINT 'FK constraint FK_edfi_StudentAssessment_Assessment already exists';
GO

