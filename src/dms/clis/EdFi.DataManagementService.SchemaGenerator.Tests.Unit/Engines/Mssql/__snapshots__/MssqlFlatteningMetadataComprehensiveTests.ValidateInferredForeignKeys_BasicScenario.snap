-- Check if FK constraint FK_edfi_StudentSchoolAssociation_Student already exists
IF NOT EXISTS (
    SELECT 1 FROM sys.foreign_keys fk
    INNER JOIN sys.schemas s ON fk.schema_id = s.schema_id
    WHERE fk.name = 'FK_edfi_StudentSchoolAssociation_Student'
    AND s.name = 'dms'
)
BEGIN
    -- Verify referenced table exists
    IF EXISTS (
        SELECT 1 FROM sys.tables t
        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
        WHERE t.name = 'edfi_Student'
        AND s.name = 'dms'
    )
    BEGIN
        ALTER TABLE [dms].[edfi_StudentSchoolAssociation]
        ADD CONSTRAINT [FK_edfi_StudentSchoolAssociation_Student]
        FOREIGN KEY ([Student_Id])
        REFERENCES [dms].[edfi_Student]([Id]);

        PRINT 'Created FK constraint: FK_edfi_StudentSchoolAssociation_Student';
    END
    ELSE
        PRINT 'Skipped FK constraint FK_edfi_StudentSchoolAssociation_Student: Referenced table does not exist';
END
ELSE
    PRINT 'FK constraint FK_edfi_StudentSchoolAssociation_Student already exists';
GO



-- Check if FK constraint FK_edfi_StudentSchoolAssociation_School already exists
IF NOT EXISTS (
    SELECT 1 FROM sys.foreign_keys fk
    INNER JOIN sys.schemas s ON fk.schema_id = s.schema_id
    WHERE fk.name = 'FK_edfi_StudentSchoolAssociation_School'
    AND s.name = 'dms'
)
BEGIN
    -- Verify referenced table exists
    IF EXISTS (
        SELECT 1 FROM sys.tables t
        INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
        WHERE t.name = 'edfi_School'
        AND s.name = 'dms'
    )
    BEGIN
        ALTER TABLE [dms].[edfi_StudentSchoolAssociation]
        ADD CONSTRAINT [FK_edfi_StudentSchoolAssociation_School]
        FOREIGN KEY ([School_Id])
        REFERENCES [dms].[edfi_School]([Id]);

        PRINT 'Created FK constraint: FK_edfi_StudentSchoolAssociation_School';
    END
    ELSE
        PRINT 'Skipped FK constraint FK_edfi_StudentSchoolAssociation_School: Referenced table does not exist';
END
ELSE
    PRINT 'FK constraint FK_edfi_StudentSchoolAssociation_School already exists';
GO

