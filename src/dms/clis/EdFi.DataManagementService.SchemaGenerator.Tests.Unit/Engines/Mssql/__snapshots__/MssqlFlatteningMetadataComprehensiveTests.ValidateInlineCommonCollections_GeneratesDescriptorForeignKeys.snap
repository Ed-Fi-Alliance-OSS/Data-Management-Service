-- MSSQL CREATE TABLE edfi_Assessment
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_Assessment' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_Assessment] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] SMALLINT NOT NULL,
    [AssessmentIdentifier] INT NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_Assessment_NaturalKey]
        UNIQUE ([AssessmentIdentifier])
    );
    PRINT 'Table edfi_Assessment created.';
END
ELSE
    PRINT 'Table edfi_Assessment already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_Assessment_Document' AND object_id = OBJECT_ID('[dms].[edfi_Assessment]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_Assessment_Document]
        ON [dms].[edfi_Assessment]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_Assessment_Document created.';
END

-- MSSQL CREATE TABLE edfi_AssessmentAssessmentIdentificationCode
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_AssessmentAssessmentIdentificationCode' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_AssessmentAssessmentIdentificationCode] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] SMALLINT NOT NULL,
    [Assessment_Id] BIGINT NOT NULL,
    [IdentificationCode] NVARCHAR(30) NOT NULL,
    [AssessmentIdentificationSystemDescriptorId] BIGINT NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_AssessmentAssessmentIdentificationCode_Identity]
        UNIQUE ([Assessment_Id], [AssessmentIdentificationSystemDescriptorId])
    );
    PRINT 'Table edfi_AssessmentAssessmentIdentificationCode created.';
END
ELSE
    PRINT 'Table edfi_AssessmentAssessmentIdentificationCode already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_AssessmentAssessmentIdentificationCode_Assessment' AND object_id = OBJECT_ID('[dms].[edfi_AssessmentAssessmentIdentificationCode]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_AssessmentAssessmentIdentificationCode_Assessment]
        ON [dms].[edfi_AssessmentAssessmentIdentificationCode]([Assessment_Id]);
    PRINT 'Index IX_AssessmentAssessmentIdentificationCode_Assessment created.';
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_AssessmentAssessmentIdentificationCode_Document' AND object_id = OBJECT_ID('[dms].[edfi_AssessmentAssessmentIdentificationCode]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_AssessmentAssessmentIdentificationCode_Document]
        ON [dms].[edfi_AssessmentAssessmentIdentificationCode]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_AssessmentAssessmentIdentificationCode_Document created.';
END


-- Foreign Key Constraints

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_Assessment_Document')
BEGIN
    ALTER TABLE [dms].[edfi_Assessment] ADD CONSTRAINT [FK_Assessment_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_Assessment_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_Assessment_Document already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_AssessmentAssessmentIdentificationCode_Assessment')
BEGIN
    ALTER TABLE [dms].[edfi_AssessmentAssessmentIdentificationCode] ADD CONSTRAINT [FK_AssessmentAssessmentIdentificationCode_Assessment] FOREIGN KEY ([Assessment_Id]) REFERENCES [dms].[edfi_Assessment]([Id]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_AssessmentAssessmentIdentificationCode_Assessment created.';
END
ELSE
    PRINT 'Foreign key constraint FK_AssessmentAssessmentIdentificationCode_Assessment already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_AssessmentAssessmentIdentificationCode_AssessmentIdentificationSystemDescriptorId_Descriptor')
BEGIN
    ALTER TABLE [dms].[edfi_AssessmentAssessmentIdentificationCode] ADD CONSTRAINT [FK_AssessmentAssessmentIdentificationCode_AssessmentIdentificationSystemDescriptorId_Descriptor] FOREIGN KEY ([AssessmentIdentificationSystemDescriptorId]) REFERENCES [dms].[edfi_Descriptor]([Id]);
    PRINT 'Foreign key constraint FK_AssessmentAssessmentIdentificationCode_AssessmentIdentificationSystemDescriptorId_Descriptor created.';
END
ELSE
    PRINT 'Foreign key constraint FK_AssessmentAssessmentIdentificationCode_AssessmentIdentificationSystemDescriptorId_Descriptor already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_AssessmentAssessmentIdentificationCode_Document')
BEGIN
    ALTER TABLE [dms].[edfi_AssessmentAssessmentIdentificationCode] ADD CONSTRAINT [FK_AssessmentAssessmentIdentificationCode_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]);
    PRINT 'Foreign key constraint FK_AssessmentAssessmentIdentificationCode_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_AssessmentAssessmentIdentificationCode_Document already exists, skipped.';
GO


-- Natural Key Resolution Views

-- Natural Key Resolution View for Assessment_View
IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'Assessment_View' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    EXEC('CREATE VIEW [dms].[Assessment_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.AssessmentIdentifier
    FROM [dms].[edfi_Assessment] base');
    PRINT 'View Assessment_View created.';
END
ELSE
    PRINT 'View Assessment_View already exists, skipped.';
GO



-- Natural Key Resolution View for AssessmentAssessmentIdentificationCode_View
IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'AssessmentAssessmentIdentificationCode_View' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    EXEC('CREATE VIEW [dms].[AssessmentAssessmentIdentificationCode_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        parent.AssessmentIdentifier,
        base.IdentificationCode,
        base.AssessmentIdentificationSystemDescriptorId
    FROM [dms].[edfi_AssessmentAssessmentIdentificationCode] base
    INNER JOIN [dms].[edfi_Assessment] parent ON base.Assessment_Id = parent.Id');
    PRINT 'View AssessmentAssessmentIdentificationCode_View created.';
END
ELSE
    PRINT 'View AssessmentAssessmentIdentificationCode_View already exists, skipped.';
GO



