-- MSSQL CREATE TABLE edfi_StudentSpecialEducationProgramAssociation
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_StudentSpecialEducationProgramAssociation' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_StudentSpecialEducationProgramAssociation] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] TINYINT NOT NULL,
    [ContentIdentifier] NVARCHAR(30) NOT NULL,
    [IEPBeginDate] DATETIME2(7) NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_StudentSpecialEducationProgramAssociation_NaturalKey]
        UNIQUE ([ContentIdentifier], [IEPBeginDate])
    );
    PRINT 'Table edfi_StudentSpecialEducationProgramAssociation created.';
END
ELSE
    PRINT 'Table edfi_StudentSpecialEducationProgramAssociation already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_StudentSpecialEducationProgramAssociation_Document' AND object_id = OBJECT_ID('[dms].[edfi_StudentSpecialEducationProgramAssociation]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_StudentSpecialEducationProgramAssociation_Document]
        ON [dms].[edfi_StudentSpecialEducationProgramAssociation]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_StudentSpecialEducationProgramAssociation_Document created.';
END


-- Foreign Key Constraints

ALTER TABLE [dms].[edfi_StudentSpecialEducationProgramAssociation]
    ADD CONSTRAINT [FK_StudentSpecialEducationProgramAssociation_Document]
    FOREIGN KEY ([Document_Id, Document_PartitionKey])
    REFERENCES [dms].[Document]([Id, DocumentPartitionKey]) ON DELETE CASCADE;

