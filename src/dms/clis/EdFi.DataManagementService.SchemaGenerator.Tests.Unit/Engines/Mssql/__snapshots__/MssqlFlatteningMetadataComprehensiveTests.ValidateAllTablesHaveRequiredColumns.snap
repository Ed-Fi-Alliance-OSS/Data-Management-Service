-- MSSQL CREATE TABLE edfi_Student
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_Student' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_Student] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] TINYINT NOT NULL,
    [StudentUniqueId] NVARCHAR(32) NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_Student_NaturalKey]
        UNIQUE ([StudentUniqueId])
    );
    PRINT 'Table edfi_Student created.';
END
ELSE
    PRINT 'Table edfi_Student already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_Student_Document' AND object_id = OBJECT_ID('[dms].[edfi_Student]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_Student_Document]
        ON [dms].[edfi_Student]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_Student_Document created.';
END

-- MSSQL CREATE TABLE edfi_StudentAddress
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_StudentAddress' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_StudentAddress] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] TINYINT NOT NULL,
    [Student_Id] BIGINT NOT NULL,
    [AddressTypeDescriptorId] INT NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_StudentAddress_Identity]
        UNIQUE ([Student_Id], [AddressTypeDescriptorId])
    );
    PRINT 'Table edfi_StudentAddress created.';
END
ELSE
    PRINT 'Table edfi_StudentAddress already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_StudentAddress_Student' AND object_id = OBJECT_ID('[dms].[edfi_StudentAddress]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_StudentAddress_Student]
        ON [dms].[edfi_StudentAddress]([Student_Id]);
    PRINT 'Index IX_StudentAddress_Student created.';
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_StudentAddress_Document' AND object_id = OBJECT_ID('[dms].[edfi_StudentAddress]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_StudentAddress_Document]
        ON [dms].[edfi_StudentAddress]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_StudentAddress_Document created.';
END


-- Foreign Key Constraints

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_Student_Document')
BEGIN
    ALTER TABLE [dms].[edfi_Student] ADD CONSTRAINT [FK_Student_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_Student_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_Student_Document already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_StudentAddress_Student')
BEGIN
    ALTER TABLE [dms].[edfi_StudentAddress] ADD CONSTRAINT [FK_StudentAddress_Student] FOREIGN KEY ([Student_Id]) REFERENCES [dms].[edfi_Student]([Id]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_StudentAddress_Student created.';
END
ELSE
    PRINT 'Foreign key constraint FK_StudentAddress_Student already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_StudentAddress_Document')
BEGIN
    ALTER TABLE [dms].[edfi_StudentAddress] ADD CONSTRAINT [FK_StudentAddress_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_StudentAddress_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_StudentAddress_Document already exists, skipped.';
GO

