-- MSSQL CREATE TABLE edfi_School
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_School' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_School] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] TINYINT NOT NULL,
    [EducationOrganizationId] INT NOT NULL,
    [NameOfInstitution] NVARCHAR(255) NOT NULL,
    [SchoolTypeDescriptor] BIGINT,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_School_NaturalKey]
        UNIQUE ([EducationOrganizationId])
    );
    PRINT 'Table edfi_School created.';
END
ELSE
    PRINT 'Table edfi_School already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_School_Document' AND object_id = OBJECT_ID('[dms].[edfi_School]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_School_Document]
        ON [dms].[edfi_School]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_School_Document created.';
END

-- MSSQL CREATE TABLE edfi_LocalEducationAgency
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_LocalEducationAgency' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_LocalEducationAgency] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] TINYINT NOT NULL,
    [EducationOrganizationId] INT NOT NULL,
    [NameOfInstitution] NVARCHAR(255) NOT NULL,
    [LocalEducationAgencyCategoryDescriptor] BIGINT NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_LocalEducationAgency_NaturalKey]
        UNIQUE ([EducationOrganizationId])
    );
    PRINT 'Table edfi_LocalEducationAgency created.';
END
ELSE
    PRINT 'Table edfi_LocalEducationAgency already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_LocalEducationAgency_Document' AND object_id = OBJECT_ID('[dms].[edfi_LocalEducationAgency]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_LocalEducationAgency_Document]
        ON [dms].[edfi_LocalEducationAgency]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_LocalEducationAgency_Document created.';
END

-- MSSQL CREATE TABLE edfi_StateEducationAgency
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_StateEducationAgency' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_StateEducationAgency] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] TINYINT NOT NULL,
    [EducationOrganizationId] INT NOT NULL,
    [NameOfInstitution] NVARCHAR(255) NOT NULL,
    [StateEducationAgencyCategoryDescriptor] BIGINT,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_StateEducationAgency_NaturalKey]
        UNIQUE ([EducationOrganizationId])
    );
    PRINT 'Table edfi_StateEducationAgency created.';
END
ELSE
    PRINT 'Table edfi_StateEducationAgency already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_StateEducationAgency_Document' AND object_id = OBJECT_ID('[dms].[edfi_StateEducationAgency]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_StateEducationAgency_Document]
        ON [dms].[edfi_StateEducationAgency]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_StateEducationAgency_Document created.';
END


-- Foreign Key Constraints

ALTER TABLE [dms].[edfi_School]
    ADD CONSTRAINT [FK_School_Document]
    FOREIGN KEY ([Document_Id, Document_PartitionKey])
    REFERENCES [dms].[Document]([Id, DocumentPartitionKey]) ON DELETE CASCADE;

ALTER TABLE [dms].[edfi_LocalEducationAgency]
    ADD CONSTRAINT [FK_LocalEducationAgency_Document]
    FOREIGN KEY ([Document_Id, Document_PartitionKey])
    REFERENCES [dms].[Document]([Id, DocumentPartitionKey]) ON DELETE CASCADE;

ALTER TABLE [dms].[edfi_StateEducationAgency]
    ADD CONSTRAINT [FK_StateEducationAgency_Document]
    FOREIGN KEY ([Document_Id, Document_PartitionKey])
    REFERENCES [dms].[Document]([Id, DocumentPartitionKey]) ON DELETE CASCADE;

-- SQL Server Union View
IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'edfi_EducationOrganization' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    EXEC('CREATE VIEW [dms].[edfi_EducationOrganization] AS
SELECT [Id], ''School'' AS [Discriminator], [Document_Id], [Document_PartitionKey], [CreateDate], [LastModifiedDate], [ChangeVersion] FROM dms.[edfi_School]
UNION ALL
SELECT [Id], ''LocalEducationAgency'' AS [Discriminator], [Document_Id], [Document_PartitionKey], [CreateDate], [LastModifiedDate], [ChangeVersion] FROM dms.[edfi_LocalEducationAgency]
UNION ALL
SELECT [Id], ''StateEducationAgency'' AS [Discriminator], [Document_Id], [Document_PartitionKey], [CreateDate], [LastModifiedDate], [ChangeVersion] FROM dms.[edfi_StateEducationAgency]
');
    PRINT 'View edfi_EducationOrganization created.';
END
ELSE
BEGIN
    EXEC('ALTER VIEW [dms].[edfi_EducationOrganization] AS
SELECT [Id], ''School'' AS [Discriminator], [Document_Id], [Document_PartitionKey], [CreateDate], [LastModifiedDate], [ChangeVersion] FROM dms.[edfi_School]
UNION ALL
SELECT [Id], ''LocalEducationAgency'' AS [Discriminator], [Document_Id], [Document_PartitionKey], [CreateDate], [LastModifiedDate], [ChangeVersion] FROM dms.[edfi_LocalEducationAgency]
UNION ALL
SELECT [Id], ''StateEducationAgency'' AS [Discriminator], [Document_Id], [Document_PartitionKey], [CreateDate], [LastModifiedDate], [ChangeVersion] FROM dms.[edfi_StateEducationAgency]
');
    PRINT 'View edfi_EducationOrganization altered.';
END

