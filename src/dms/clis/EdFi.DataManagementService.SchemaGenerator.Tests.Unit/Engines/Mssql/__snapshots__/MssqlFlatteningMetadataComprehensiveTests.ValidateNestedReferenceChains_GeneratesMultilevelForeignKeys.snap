-- MSSQL CREATE TABLE edfi_DomainEntityName
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_DomainEntityName' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_DomainEntityName] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] SMALLINT NOT NULL,
    [SectionIdentifier] NVARCHAR(30) NOT NULL,
    [CourseOffering_Id] BIGINT NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_DomainEntityName_NaturalKey]
        UNIQUE ([SectionIdentifier], [CourseOffering_Id])
    );
    PRINT 'Table edfi_DomainEntityName created.';
END
ELSE
    PRINT 'Table edfi_DomainEntityName already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_DomainEntityName_CourseOffering' AND object_id = OBJECT_ID('[dms].[edfi_DomainEntityName]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_DomainEntityName_CourseOffering]
        ON [dms].[edfi_DomainEntityName]([CourseOffering_Id]);
    PRINT 'Index IX_DomainEntityName_CourseOffering created.';
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_DomainEntityName_Document' AND object_id = OBJECT_ID('[dms].[edfi_DomainEntityName]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_DomainEntityName_Document]
        ON [dms].[edfi_DomainEntityName]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_DomainEntityName_Document created.';
END

-- MSSQL CREATE TABLE edfi_DomainEntityNameClassPeriod
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_DomainEntityNameClassPeriod' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_DomainEntityNameClassPeriod] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] SMALLINT NOT NULL,
    [DomainEntityName_Id] BIGINT NOT NULL,
    [ClassPeriod_Id] BIGINT NOT NULL,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
    );
    PRINT 'Table edfi_DomainEntityNameClassPeriod created.';
END
ELSE
    PRINT 'Table edfi_DomainEntityNameClassPeriod already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_DomainEntityNameClassPeriod_DomainEntityName' AND object_id = OBJECT_ID('[dms].[edfi_DomainEntityNameClassPeriod]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_DomainEntityNameClassPeriod_DomainEntityName]
        ON [dms].[edfi_DomainEntityNameClassPeriod]([DomainEntityName_Id]);
    PRINT 'Index IX_DomainEntityNameClassPeriod_DomainEntityName created.';
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_DomainEntityNameClassPeriod_ClassPeriod' AND object_id = OBJECT_ID('[dms].[edfi_DomainEntityNameClassPeriod]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_DomainEntityNameClassPeriod_ClassPeriod]
        ON [dms].[edfi_DomainEntityNameClassPeriod]([ClassPeriod_Id]);
    PRINT 'Index IX_DomainEntityNameClassPeriod_ClassPeriod created.';
END
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_DomainEntityNameClassPeriod_Document' AND object_id = OBJECT_ID('[dms].[edfi_DomainEntityNameClassPeriod]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_DomainEntityNameClassPeriod_Document]
        ON [dms].[edfi_DomainEntityNameClassPeriod]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_DomainEntityNameClassPeriod_Document created.';
END


-- Foreign Key Constraints

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_DomainEntityName_Document')
BEGIN
    ALTER TABLE [dms].[edfi_DomainEntityName] ADD CONSTRAINT [FK_DomainEntityName_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_DomainEntityName_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_DomainEntityName_Document already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_DomainEntityNameClassPeriod_DomainEntityName')
BEGIN
    ALTER TABLE [dms].[edfi_DomainEntityNameClassPeriod] ADD CONSTRAINT [FK_DomainEntityNameClassPeriod_DomainEntityName] FOREIGN KEY ([DomainEntityName_Id]) REFERENCES [dms].[edfi_DomainEntityName]([Id]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_DomainEntityNameClassPeriod_DomainEntityName created.';
END
ELSE
    PRINT 'Foreign key constraint FK_DomainEntityNameClassPeriod_DomainEntityName already exists, skipped.';
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_DomainEntityNameClassPeriod_Document')
BEGIN
    ALTER TABLE [dms].[edfi_DomainEntityNameClassPeriod] ADD CONSTRAINT [FK_DomainEntityNameClassPeriod_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]);
    PRINT 'Foreign key constraint FK_DomainEntityNameClassPeriod_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_DomainEntityNameClassPeriod_Document already exists, skipped.';
GO


-- Natural Key Resolution Views

-- Natural Key Resolution View for DomainEntityName_View
IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'DomainEntityName_View' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    EXEC('CREATE VIEW [dms].[DomainEntityName_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.CreateDate,
        base.LastModifiedDate,
        base.ChangeVersion,
        base.SectionIdentifier,
        base.CourseOffering_Id
    FROM [dms].[edfi_DomainEntityName] base');
    PRINT 'View DomainEntityName_View created.';
END
ELSE
BEGIN
    EXEC('ALTER VIEW [dms].[DomainEntityName_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.CreateDate,
        base.LastModifiedDate,
        base.ChangeVersion,
        base.SectionIdentifier,
        base.CourseOffering_Id
    FROM [dms].[edfi_DomainEntityName] base');
    PRINT 'View DomainEntityName_View altered.';
END
GO



-- Natural Key Resolution View for DomainEntityNameClassPeriod_View
IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'DomainEntityNameClassPeriod_View' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    EXEC('CREATE VIEW [dms].[DomainEntityNameClassPeriod_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.CreateDate,
        base.LastModifiedDate,
        base.ChangeVersion,
        base.DomainEntityName_Id,
        parent.SectionIdentifier AS DomainEntityName_SectionIdentifier,
        parent.CourseOffering_Id AS DomainEntityName_CourseOffering_Id,
        base.ClassPeriod_Id
    FROM [dms].[edfi_DomainEntityNameClassPeriod] base
    INNER JOIN [dms].[edfi_DomainEntityName] parent ON base.DomainEntityName_Id = parent.Id');
    PRINT 'View DomainEntityNameClassPeriod_View created.';
END
ELSE
BEGIN
    EXEC('ALTER VIEW [dms].[DomainEntityNameClassPeriod_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.CreateDate,
        base.LastModifiedDate,
        base.ChangeVersion,
        base.DomainEntityName_Id,
        parent.SectionIdentifier AS DomainEntityName_SectionIdentifier,
        parent.CourseOffering_Id AS DomainEntityName_CourseOffering_Id,
        base.ClassPeriod_Id
    FROM [dms].[edfi_DomainEntityNameClassPeriod] base
    INNER JOIN [dms].[edfi_DomainEntityName] parent ON base.DomainEntityName_Id = parent.Id');
    PRINT 'View DomainEntityNameClassPeriod_View altered.';
END
GO



