-- MSSQL CREATE TABLE edfi_GeneralStudentProgramAssociation
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'edfi_GeneralStudentProgramAssociation' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    CREATE TABLE [dms].[edfi_GeneralStudentProgramAssociation] (
    [Id] BIGINT PRIMARY KEY IDENTITY(1,1),
    [Document_Id] BIGINT NOT NULL,
    [Document_PartitionKey] SMALLINT NOT NULL,
    [StudentUniqueId] NVARCHAR(32) NOT NULL,
    [ProgramEducationOrganizationId] INT NOT NULL,
    [ProgramName] NVARCHAR(60) NOT NULL,
    [ProgramTypeDescriptor] BIGINT NOT NULL,
    [BeginDate] DATE NOT NULL,
    [ServedOutsideOfRegularSession] BIT,
    [CreateDate] DATETIME2 NOT NULL,
    [LastModifiedDate] DATETIME2 NOT NULL,
    [ChangeVersion] BIGINT NOT NULL
,
    CONSTRAINT [UQ_GeneralStudentProgramAssociation_NaturalKey]
        UNIQUE ([StudentUniqueId], [ProgramEducationOrganizationId], [ProgramName], [ProgramTypeDescriptor], [BeginDate])
    );
    PRINT 'Table edfi_GeneralStudentProgramAssociation created.';
END
ELSE
    PRINT 'Table edfi_GeneralStudentProgramAssociation already exists, skipped.';

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_GeneralStudentProgramAssociation_Document' AND object_id = OBJECT_ID('[dms].[edfi_GeneralStudentProgramAssociation]'))
BEGIN
    CREATE NONCLUSTERED INDEX [IX_GeneralStudentProgramAssociation_Document]
        ON [dms].[edfi_GeneralStudentProgramAssociation]([Document_Id], [Document_PartitionKey]);
    PRINT 'Index IX_GeneralStudentProgramAssociation_Document created.';
END


-- Foreign Key Constraints

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'FK_GeneralStudentProgramAssociation_Document')
BEGIN
    ALTER TABLE [dms].[edfi_GeneralStudentProgramAssociation] ADD CONSTRAINT [FK_GeneralStudentProgramAssociation_Document] FOREIGN KEY ([Document_Id], [Document_PartitionKey]) REFERENCES [dms].[Document]([Id], [DocumentPartitionKey]) ON DELETE CASCADE;
    PRINT 'Foreign key constraint FK_GeneralStudentProgramAssociation_Document created.';
END
ELSE
    PRINT 'Foreign key constraint FK_GeneralStudentProgramAssociation_Document already exists, skipped.';
GO


-- Natural Key Resolution Views

-- Natural Key Resolution View for GeneralStudentProgramAssociation_View
IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'GeneralStudentProgramAssociation_View' AND SCHEMA_NAME(schema_id) = 'dms')
BEGIN
    EXEC('CREATE VIEW [dms].[GeneralStudentProgramAssociation_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.CreateDate,
        base.LastModifiedDate,
        base.ChangeVersion,
        base.StudentUniqueId,
        base.ProgramEducationOrganizationId,
        base.ProgramName,
        base.ProgramTypeDescriptor,
        base.BeginDate,
        base.ServedOutsideOfRegularSession
    FROM [dms].[edfi_GeneralStudentProgramAssociation] base');
    PRINT 'View GeneralStudentProgramAssociation_View created.';
END
ELSE
BEGIN
    EXEC('ALTER VIEW [dms].[GeneralStudentProgramAssociation_View] AS
    SELECT
        base.Id,
        base.Document_Id,
        base.Document_PartitionKey,
        base.CreateDate,
        base.LastModifiedDate,
        base.ChangeVersion,
        base.StudentUniqueId,
        base.ProgramEducationOrganizationId,
        base.ProgramName,
        base.ProgramTypeDescriptor,
        base.BeginDate,
        base.ServedOutsideOfRegularSession
    FROM [dms].[edfi_GeneralStudentProgramAssociation] base');
    PRINT 'View GeneralStudentProgramAssociation_View altered.';
END
GO



