CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_Student (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_Student_Document
    ON dms.edfi_Student(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_Student_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_Student ADD CONSTRAINT UQ_Student_NaturalKey
            UNIQUE (StudentUniqueId);
    END IF;
END$$;



CREATE TABLE IF NOT EXISTS dms.edfi_Grade (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    Student_Id BIGINT NOT NULL,
    GradeIdentifier VARCHAR(60) NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_Grade_Document
    ON dms.edfi_Grade(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_Grade_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_Grade ADD CONSTRAINT UQ_Grade_NaturalKey
            UNIQUE (Student_Id, GradeIdentifier);
    END IF;
END$$;


-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_Student_Document')
        ) THEN
            ALTER TABLE dms.edfi_Student ADD CONSTRAINT FK_Student_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_Grade_Student')
        ) THEN
            ALTER TABLE dms.edfi_Grade ADD CONSTRAINT FK_Grade_Student
                FOREIGN KEY (Student_Id)
                REFERENCES dms.edfi_Student(Id);
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_Grade_Document')
        ) THEN
            ALTER TABLE dms.edfi_Grade ADD CONSTRAINT FK_Grade_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;


-- Natural Key Resolution Views

-- Natural Key Resolution View for Student_View
CREATE OR REPLACE VIEW dms.Student_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.StudentUniqueId
FROM dms.edfi_Student base;



-- Natural Key Resolution View for Grade_View
CREATE OR REPLACE VIEW dms.Grade_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.Student_Id AS StudentId,
    student.StudentUniqueId AS StudentUniqueId,
    base.GradeIdentifier
FROM dms.edfi_Grade base
    INNER JOIN dms.edfi_Student student ON base.Student_Id = student.Id;



