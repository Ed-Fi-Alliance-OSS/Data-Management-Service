CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_Assessment (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    AssessmentIdentifier VARCHAR(60) NOT NULL,
    Namespace VARCHAR(255) NOT NULL,
    AssessmentTitle VARCHAR(100) NOT NULL,
    AssessmentCategoryDescriptor BIGINT NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_Assessment_Document
    ON dms.edfi_Assessment(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_Assessment_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_Assessment ADD CONSTRAINT UQ_Assessment_NaturalKey
            UNIQUE (AssessmentIdentifier, Namespace);
    END IF;
END$$;



CREATE TABLE IF NOT EXISTS dms.edfi_ObjectiveAssessment (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    AssessmentIdentifier VARCHAR(60) NOT NULL,
    IdentificationCode VARCHAR(60) NOT NULL,
    Namespace VARCHAR(255) NOT NULL,
    Description VARCHAR(1024),
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_ObjectiveAssessment_Document
    ON dms.edfi_ObjectiveAssessment(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_ObjectiveAssessment_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_ObjectiveAssessment ADD CONSTRAINT UQ_ObjectiveAssessment_NaturalKey
            UNIQUE (AssessmentIdentifier, IdentificationCode, Namespace);
    END IF;
END$$;


-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_Assessment_AssessmentCategoryDescriptor_Descriptor')
        ) THEN
            ALTER TABLE dms.edfi_Assessment ADD CONSTRAINT FK_Assessment_AssessmentCategoryDescriptor_Descriptor
                FOREIGN KEY (AssessmentCategoryDescriptor)
                REFERENCES dms.edfi_descriptor(Id);
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_Assessment_Document')
        ) THEN
            ALTER TABLE dms.edfi_Assessment ADD CONSTRAINT FK_Assessment_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_ObjectiveAssessment_Document')
        ) THEN
            ALTER TABLE dms.edfi_ObjectiveAssessment ADD CONSTRAINT FK_ObjectiveAssessment_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;


-- Natural Key Resolution Views

-- Natural Key Resolution View for Assessment_View
CREATE OR REPLACE VIEW dms.Assessment_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.AssessmentIdentifier,
    base.Namespace,
    base.AssessmentTitle,
    base.AssessmentCategoryDescriptor
FROM dms.edfi_Assessment base;



-- Natural Key Resolution View for ObjectiveAssessment_View
CREATE OR REPLACE VIEW dms.ObjectiveAssessment_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.AssessmentIdentifier,
    base.IdentificationCode,
    base.Namespace,
    base.Description
FROM dms.edfi_ObjectiveAssessment base;



