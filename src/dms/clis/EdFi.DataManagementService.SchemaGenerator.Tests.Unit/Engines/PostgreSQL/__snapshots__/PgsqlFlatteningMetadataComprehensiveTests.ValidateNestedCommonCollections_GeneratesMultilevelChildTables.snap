CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_StudentEducationOrganizationAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentId INTEGER NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_StudentEducationOrganizationAssociation_Document
    ON dms.edfi_StudentEducationOrganizationAssociation(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_StudentEducationOrganizationAssociation_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_StudentEducationOrganizationAssociation ADD CONSTRAINT UQ_StudentEducationOrganizationAssociation_NaturalKey
            UNIQUE (StudentId);
    END IF;
END$$;



CREATE TABLE IF NOT EXISTS dms.edfi_StudentEducationOrganizationAssociationAddress (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentEducationOrganizationAssociation_Id BIGINT NOT NULL,
    StreetNumberName VARCHAR(30) NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_StudentEducationOrganizationAssociationAddress_Document
    ON dms.edfi_StudentEducationOrganizationAssociationAddress(Document_Id, Document_PartitionKey);





CREATE TABLE IF NOT EXISTS dms.edfi_StudentEducationOrganizationAssociationAddressPeriod (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentEducationOrganizationAssociationAddress_Id BIGINT NOT NULL,
    BeginDate INTEGER NOT NULL,
    EndDate INTEGER,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_StudentEducationOrganizationAssociationAddressPerio_3a56ca03
    ON dms.edfi_StudentEducationOrganizationAssociationAddressPeriod(Document_Id, Document_PartitionKey);




-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentEducationOrganizationAssociation_Document')
        ) THEN
            ALTER TABLE dms.edfi_StudentEducationOrganizationAssociation ADD CONSTRAINT FK_StudentEducationOrganizationAssociation_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentEducationOrganizationAssociationAddress_Stud_052fda57')
        ) THEN
            ALTER TABLE dms.edfi_StudentEducationOrganizationAssociationAddress ADD CONSTRAINT FK_StudentEducationOrganizationAssociationAddress_Stud_052fda57
                FOREIGN KEY (StudentEducationOrganizationAssociation_Id)
                REFERENCES dms.edfi_StudentEducationOrganizationAssociation(Id) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentEducationOrganizationAssociationAddress_Document')
        ) THEN
            ALTER TABLE dms.edfi_StudentEducationOrganizationAssociationAddress ADD CONSTRAINT FK_StudentEducationOrganizationAssociationAddress_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentEducationOrganizationAssociationAddressPerio_8f88f5b7')
        ) THEN
            ALTER TABLE dms.edfi_StudentEducationOrganizationAssociationAddressPeriod ADD CONSTRAINT FK_StudentEducationOrganizationAssociationAddressPerio_8f88f5b7
                FOREIGN KEY (StudentEducationOrganizationAssociationAddress_Id)
                REFERENCES dms.edfi_StudentEducationOrganizationAssociationAddress(Id) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentEducationOrganizationAssociationAddressPerio_00177584')
        ) THEN
            ALTER TABLE dms.edfi_StudentEducationOrganizationAssociationAddressPeriod ADD CONSTRAINT FK_StudentEducationOrganizationAssociationAddressPerio_00177584
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

