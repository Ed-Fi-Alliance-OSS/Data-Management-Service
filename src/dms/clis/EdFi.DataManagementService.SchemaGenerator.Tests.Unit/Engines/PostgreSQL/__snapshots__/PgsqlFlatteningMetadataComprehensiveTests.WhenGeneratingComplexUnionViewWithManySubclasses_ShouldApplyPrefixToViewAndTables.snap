CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_StudentCTEProgramAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    BeginDate DATE NOT NULL,
    NonTraditionalGenderStatus BOOLEAN,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_StudentCTEProgramAssociation_Document
    ON dms.edfi_StudentCTEProgramAssociation(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_StudentCTEProgramAssociation_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_StudentCTEProgramAssociation ADD CONSTRAINT UQ_StudentCTEProgramAssociation_NaturalKey
            UNIQUE (StudentUniqueId, BeginDate);
    END IF;
END$$;



CREATE TABLE IF NOT EXISTS dms.edfi_StudentHomelessProgramAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    BeginDate DATE NOT NULL,
    AwaitingFosterCare BOOLEAN,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_StudentHomelessProgramAssociation_Document
    ON dms.edfi_StudentHomelessProgramAssociation(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_StudentHomelessProgramAssociation_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_StudentHomelessProgramAssociation ADD CONSTRAINT UQ_StudentHomelessProgramAssociation_NaturalKey
            UNIQUE (StudentUniqueId, BeginDate);
    END IF;
END$$;


-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentCTEProgramAssociation_Document')
        ) THEN
            ALTER TABLE dms.edfi_StudentCTEProgramAssociation ADD CONSTRAINT FK_StudentCTEProgramAssociation_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentHomelessProgramAssociation_Document')
        ) THEN
            ALTER TABLE dms.edfi_StudentHomelessProgramAssociation ADD CONSTRAINT FK_StudentHomelessProgramAssociation_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;


-- Natural Key Resolution Views

-- Natural Key Resolution View for StudentCTEProgramAssociation_View
CREATE OR REPLACE VIEW dms.StudentCTEProgramAssociation_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.CreateDate,
    base.LastModifiedDate,
    base.ChangeVersion,
    base.StudentUniqueId,
    base.BeginDate,
    base.NonTraditionalGenderStatus
FROM dms.edfi_StudentCTEProgramAssociation base;



-- Natural Key Resolution View for StudentHomelessProgramAssociation_View
CREATE OR REPLACE VIEW dms.StudentHomelessProgramAssociation_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.CreateDate,
    base.LastModifiedDate,
    base.ChangeVersion,
    base.StudentUniqueId,
    base.BeginDate,
    base.AwaitingFosterCare
FROM dms.edfi_StudentHomelessProgramAssociation base;



-- PostgreSQL Union View
CREATE OR REPLACE VIEW dms.edfi_GeneralStudentProgramAssociation AS
SELECT Id, BeginDate AS GeneralStudentProgramAssociationId, StudentUniqueId, 'StudentCTEProgramAssociation' AS Discriminator, Document_Id, Document_PartitionKey, CreateDate, LastModifiedDate, ChangeVersion FROM dms.edfi_StudentCTEProgramAssociation
UNION ALL
SELECT Id, BeginDate AS GeneralStudentProgramAssociationId, StudentUniqueId, 'StudentHomelessProgramAssociation' AS Discriminator, Document_Id, Document_PartitionKey, CreateDate, LastModifiedDate, ChangeVersion FROM dms.edfi_StudentHomelessProgramAssociation
;

