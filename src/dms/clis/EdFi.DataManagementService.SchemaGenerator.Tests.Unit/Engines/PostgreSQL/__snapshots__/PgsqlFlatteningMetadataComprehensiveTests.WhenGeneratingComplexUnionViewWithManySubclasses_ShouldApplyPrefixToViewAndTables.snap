CREATE SCHEMA IF NOT EXISTS dms;


CREATE TABLE IF NOT EXISTS dms.edfi_StudentCTEProgramAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    BeginDate DATE NOT NULL,
    NonTraditionalGenderStatus BOOLEAN,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
,
    CONSTRAINT UQ_StudentCTEProgramAssociation_NaturalKey
        UNIQUE (StudentUniqueId, BeginDate)
);

CREATE INDEX IF NOT EXISTS IX_StudentCTEProgramAssociation_Document
    ON dms.edfi_StudentCTEProgramAssociation(Document_Id, Document_PartitionKey);


CREATE TABLE IF NOT EXISTS dms.edfi_StudentHomelessProgramAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    BeginDate DATE NOT NULL,
    AwaitingFosterCare BOOLEAN,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
,
    CONSTRAINT UQ_StudentHomelessProgramAssociation_NaturalKey
        UNIQUE (StudentUniqueId, BeginDate)
);

CREATE INDEX IF NOT EXISTS IX_StudentHomelessProgramAssociation_Document
    ON dms.edfi_StudentHomelessProgramAssociation(Document_Id, Document_PartitionKey);


-- Foreign Key Constraints

ALTER TABLE dms.edfi_StudentCTEProgramAssociation
    ADD CONSTRAINT FK_StudentCTEProgramAssociation_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

ALTER TABLE dms.edfi_StudentHomelessProgramAssociation
    ADD CONSTRAINT FK_StudentHomelessProgramAssociation_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

-- PostgreSQL Union View
CREATE OR REPLACE VIEW dms.edfi_GeneralStudentProgramAssociation AS
SELECT Id, 'StudentCTEProgramAssociation' AS Discriminator, Document_Id, Document_PartitionKey, CreateDate, LastModifiedDate, ChangeVersion FROM dms.edfi_StudentCTEProgramAssociation
UNION ALL
SELECT Id, 'StudentHomelessProgramAssociation' AS Discriminator, Document_Id, Document_PartitionKey, CreateDate, LastModifiedDate, ChangeVersion FROM dms.edfi_StudentHomelessProgramAssociation
;

