CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_DomainEntityName (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StringIdentity VARCHAR(30) NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_DomainEntityName_Document
    ON dms.edfi_DomainEntityName(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_DomainEntityName_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_DomainEntityName ADD CONSTRAINT UQ_DomainEntityName_NaturalKey
            UNIQUE (StringIdentity);
    END IF;
END$$;



CREATE TABLE IF NOT EXISTS dms.edfi_DomainEntityNameRequiredIntegerProperty (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    DomainEntityName_Id BIGINT NOT NULL,
    RequiredIntegerProperty INTEGER,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_DomainEntityNameRequiredIntegerProperty_Document
    ON dms.edfi_DomainEntityNameRequiredIntegerProperty(Document_Id, Document_PartitionKey);





CREATE TABLE IF NOT EXISTS dms.edfi_DomainEntityNameSchoolYear (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    DomainEntityName_Id BIGINT NOT NULL,
    SchoolYear INTEGER,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_DomainEntityNameSchoolYear_Document
    ON dms.edfi_DomainEntityNameSchoolYear(Document_Id, Document_PartitionKey);




-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_DomainEntityName_Document')
        ) THEN
            ALTER TABLE dms.edfi_DomainEntityName ADD CONSTRAINT FK_DomainEntityName_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_DomainEntityNameRequiredIntegerProperty_DomainEntityName')
        ) THEN
            ALTER TABLE dms.edfi_DomainEntityNameRequiredIntegerProperty ADD CONSTRAINT FK_DomainEntityNameRequiredIntegerProperty_DomainEntityName
                FOREIGN KEY (DomainEntityName_Id)
                REFERENCES dms.edfi_DomainEntityName(Id) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_DomainEntityNameRequiredIntegerProperty_Document')
        ) THEN
            ALTER TABLE dms.edfi_DomainEntityNameRequiredIntegerProperty ADD CONSTRAINT FK_DomainEntityNameRequiredIntegerProperty_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_DomainEntityNameSchoolYear_DomainEntityName')
        ) THEN
            ALTER TABLE dms.edfi_DomainEntityNameSchoolYear ADD CONSTRAINT FK_DomainEntityNameSchoolYear_DomainEntityName
                FOREIGN KEY (DomainEntityName_Id)
                REFERENCES dms.edfi_DomainEntityName(Id) ON DELETE CASCADE;
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_DomainEntityNameSchoolYear_Document')
        ) THEN
            ALTER TABLE dms.edfi_DomainEntityNameSchoolYear ADD CONSTRAINT FK_DomainEntityNameSchoolYear_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;


-- Natural Key Resolution Views

-- Natural Key Resolution View for DomainEntityName_View
CREATE OR REPLACE VIEW dms.DomainEntityName_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.StringIdentity
FROM dms.edfi_DomainEntityName base;



-- Natural Key Resolution View for DomainEntityNameRequiredIntegerProperty_View
CREATE OR REPLACE VIEW dms.DomainEntityNameRequiredIntegerProperty_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    parent.StringIdentity AS DomainEntityName_StringIdentity,
    base.RequiredIntegerProperty
FROM dms.edfi_DomainEntityNameRequiredIntegerProperty base
    INNER JOIN dms.edfi_DomainEntityName parent ON base.DomainEntityName_Id = parent.Id;



-- Natural Key Resolution View for DomainEntityNameSchoolYear_View
CREATE OR REPLACE VIEW dms.DomainEntityNameSchoolYear_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    parent.StringIdentity AS DomainEntityName_StringIdentity,
    base.SchoolYear
FROM dms.edfi_DomainEntityNameSchoolYear base
    INNER JOIN dms.edfi_DomainEntityName parent ON base.DomainEntityName_Id = parent.Id;



