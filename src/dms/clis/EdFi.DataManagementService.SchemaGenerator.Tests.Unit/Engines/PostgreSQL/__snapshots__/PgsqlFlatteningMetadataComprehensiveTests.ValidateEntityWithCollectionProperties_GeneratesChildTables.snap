CREATE SCHEMA IF NOT EXISTS dms;


CREATE TABLE IF NOT EXISTS dms.edfi_DomainEntityName (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StringIdentity VARCHAR(30) NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
,
    CONSTRAINT UQ_DomainEntityName_NaturalKey
        UNIQUE (StringIdentity)
);

CREATE INDEX IF NOT EXISTS IX_DomainEntityName_Document
    ON dms.edfi_DomainEntityName(Document_Id, Document_PartitionKey);


CREATE TABLE IF NOT EXISTS dms.edfi_DomainEntityNameRequiredIntegerProperty (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    DomainEntityName_Id BIGINT NOT NULL,
    RequiredIntegerProperty INTEGER,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_DomainEntityNameRequiredIntegerProperty_Document
    ON dms.edfi_DomainEntityNameRequiredIntegerProperty(Document_Id, Document_PartitionKey);


CREATE TABLE IF NOT EXISTS dms.edfi_DomainEntityNameSchoolYear (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    DomainEntityName_Id BIGINT NOT NULL,
    SchoolYear INTEGER,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_DomainEntityNameSchoolYear_Document
    ON dms.edfi_DomainEntityNameSchoolYear(Document_Id, Document_PartitionKey);


-- Foreign Key Constraints

ALTER TABLE dms.edfi_DomainEntityName
    ADD CONSTRAINT FK_DomainEntityName_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

ALTER TABLE dms.edfi_DomainEntityNameRequiredIntegerProperty
    ADD CONSTRAINT FK_DomainEntityNameRequiredIntegerProperty_DomainEntityName
    FOREIGN KEY (DomainEntityName_Id)
    REFERENCES dms.edfi_DomainEntityName(Id) ON DELETE CASCADE;

ALTER TABLE dms.edfi_DomainEntityNameRequiredIntegerProperty
    ADD CONSTRAINT FK_DomainEntityNameRequiredIntegerProperty_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

ALTER TABLE dms.edfi_DomainEntityNameSchoolYear
    ADD CONSTRAINT FK_DomainEntityNameSchoolYear_DomainEntityName
    FOREIGN KEY (DomainEntityName_Id)
    REFERENCES dms.edfi_DomainEntityName(Id) ON DELETE CASCADE;

ALTER TABLE dms.edfi_DomainEntityNameSchoolYear
    ADD CONSTRAINT FK_DomainEntityNameSchoolYear_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

