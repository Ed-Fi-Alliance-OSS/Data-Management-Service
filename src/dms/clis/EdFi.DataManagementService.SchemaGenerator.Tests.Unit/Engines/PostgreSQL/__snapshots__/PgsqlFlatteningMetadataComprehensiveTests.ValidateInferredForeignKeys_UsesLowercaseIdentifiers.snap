-- =====================================================
-- Inferred Foreign Key Constraints Generator (PostgreSQL)
-- This script scans all tables and creates FK constraints
-- based on unique constraint patterns.
-- NOTE: This does NOT include Document or Descriptor FKs,
-- as those are already handled by the main DDL generator.
-- =====================================================

-- Foreign Keys for dms.edfi_Assessment

-- Foreign Keys for dms.edfi_StudentAssessment

-- Check if FK constraint fk_edfi_studentassessment_assessment already exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints tc
        WHERE tc.constraint_name = 'fk_edfi_studentassessment_assessment'
        AND tc.table_schema = 'dms'
        AND tc.constraint_type = 'FOREIGN KEY'
    ) THEN
        -- Verify referenced table exists
        IF EXISTS (
            SELECT 1 FROM information_schema.tables t
            WHERE t.table_name = 'edfi_assessment'
            AND t.table_schema = 'dms'
        ) THEN
            ALTER TABLE "dms"."edfi_studentassessment"
            ADD CONSTRAINT "fk_edfi_studentassessment_assessment"
            FOREIGN KEY ("assessment_id")
            REFERENCES "dms"."edfi_assessment"("id");

            RAISE NOTICE 'Created FK constraint: fk_edfi_studentassessment_assessment';
        ELSE
            RAISE NOTICE 'Skipped FK constraint fk_edfi_studentassessment_assessment: Referenced table does not exist';
        END IF;
    ELSE
        RAISE NOTICE 'FK constraint fk_edfi_studentassessment_assessment already exists';
    END IF;
END $$;


