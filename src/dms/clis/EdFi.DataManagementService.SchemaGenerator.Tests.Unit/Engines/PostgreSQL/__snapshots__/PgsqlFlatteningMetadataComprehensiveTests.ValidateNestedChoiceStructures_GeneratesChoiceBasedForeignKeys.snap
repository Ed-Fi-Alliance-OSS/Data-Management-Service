CREATE SCHEMA IF NOT EXISTS dms;


CREATE TABLE IF NOT EXISTS dms.edfi_EducationContent (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    ContentIdentifier VARCHAR(30) NOT NULL,
    LearningResourceMetadataURI VARCHAR(30),
    Description VARCHAR(30),
    ShortDescription VARCHAR(30),
    ContentClassDescriptorId BIGINT,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
,
    CONSTRAINT UQ_EducationContent_NaturalKey
        UNIQUE (ContentIdentifier)
);

CREATE INDEX IF NOT EXISTS IX_EducationContent_Document
    ON dms.edfi_EducationContent(Document_Id, Document_PartitionKey);


CREATE TABLE IF NOT EXISTS dms.edfi_EducationContentDerivativeSourceEducationContent (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    EducationContent_Id BIGINT NOT NULL,
    DerivativeSource_EducationContent_Id BIGINT,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_EducationContentDerivativeSourceEducationContent_Document
    ON dms.edfi_EducationContentDerivativeSourceEducationContent(Document_Id, Document_PartitionKey);


CREATE TABLE IF NOT EXISTS dms.edfi_EducationContentRequiredURI (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    EducationContent_Id BIGINT NOT NULL,
    RequiredURI VARCHAR(30),
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_EducationContentRequiredURI_Document
    ON dms.edfi_EducationContentRequiredURI(Document_Id, Document_PartitionKey);


-- Foreign Key Constraints

ALTER TABLE dms.edfi_EducationContent
    ADD CONSTRAINT FK_EducationContent_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

ALTER TABLE dms.edfi_EducationContentDerivativeSourceEducationContent
    ADD CONSTRAINT FK_EducationContentDerivativeSourceEducationContent_EducationContent
    FOREIGN KEY (EducationContent_Id)
    REFERENCES dms.edfi_EducationContent(Id) ON DELETE CASCADE;

ALTER TABLE dms.edfi_EducationContentDerivativeSourceEducationContent
    ADD CONSTRAINT FK_EducationContentDerivativeSourceEducationContent_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

ALTER TABLE dms.edfi_EducationContentRequiredURI
    ADD CONSTRAINT FK_EducationContentRequiredURI_EducationContent
    FOREIGN KEY (EducationContent_Id)
    REFERENCES dms.edfi_EducationContent(Id) ON DELETE CASCADE;

ALTER TABLE dms.edfi_EducationContentRequiredURI
    ADD CONSTRAINT FK_EducationContentRequiredURI_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

