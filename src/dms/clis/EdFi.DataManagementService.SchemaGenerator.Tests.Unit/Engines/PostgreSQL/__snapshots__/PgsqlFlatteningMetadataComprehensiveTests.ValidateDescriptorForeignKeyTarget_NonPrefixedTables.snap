CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_otherItem (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    SomeDescriptorId BIGINT NOT NULL,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_otherItem_Document
    ON dms.edfi_otherItem(Document_Id, Document_PartitionKey);




-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_otherItem_SomeDescriptorId_Descriptor')
        ) THEN
            ALTER TABLE dms.edfi_otherItem ADD CONSTRAINT FK_otherItem_SomeDescriptorId_Descriptor
                FOREIGN KEY (SomeDescriptorId)
                REFERENCES dms.edfi_descriptor(Id);
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_otherItem_Document')
        ) THEN
            ALTER TABLE dms.edfi_otherItem ADD CONSTRAINT FK_otherItem_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;


-- Natural Key Resolution Views

-- Natural Key Resolution View for otherItem_View
CREATE OR REPLACE VIEW dms.otherItem_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.SomeDescriptorId
FROM dms.edfi_otherItem base;



