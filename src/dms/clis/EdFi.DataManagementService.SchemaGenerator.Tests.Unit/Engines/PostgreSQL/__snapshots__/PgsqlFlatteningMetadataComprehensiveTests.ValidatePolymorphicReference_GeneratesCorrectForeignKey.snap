CREATE SCHEMA IF NOT EXISTS dms;


CREATE TABLE IF NOT EXISTS dms.edfi_StudentSchoolAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    SchoolId INTEGER NOT NULL,
    EntryDate DATE NOT NULL,
    EntryGradeLevelDescriptor BIGINT NOT NULL,
    ExitWithdrawDate DATE,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
,
    CONSTRAINT UQ_StudentSchoolAssociation_NaturalKey
        UNIQUE (StudentUniqueId, SchoolId, EntryDate)
);

CREATE INDEX IF NOT EXISTS IX_StudentSchoolAssociation_Document
    ON dms.edfi_StudentSchoolAssociation(Document_Id, Document_PartitionKey);


-- Foreign Key Constraints

ALTER TABLE dms.edfi_StudentSchoolAssociation
    ADD CONSTRAINT FK_StudentSchoolAssociation_Document
    FOREIGN KEY (Document_Id, Document_PartitionKey)
    REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;

