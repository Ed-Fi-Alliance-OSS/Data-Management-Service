CREATE SCHEMA IF NOT EXISTS dms;



CREATE TABLE IF NOT EXISTS dms.edfi_StudentSchoolAssociation (
    Id BIGSERIAL PRIMARY KEY,
    Document_Id BIGINT NOT NULL,
    Document_PartitionKey SMALLINT NOT NULL,
    StudentUniqueId VARCHAR(32) NOT NULL,
    SchoolId INTEGER NOT NULL,
    EntryDate DATE NOT NULL,
    EntryGradeLevelDescriptor BIGINT NOT NULL,
    ExitWithdrawDate DATE,
    CreateDate TIMESTAMP NOT NULL,
    LastModifiedDate TIMESTAMP NOT NULL,
    ChangeVersion BIGINT NOT NULL
);

CREATE INDEX IF NOT EXISTS IX_StudentSchoolAssociation_Document
    ON dms.edfi_StudentSchoolAssociation(Document_Id, Document_PartitionKey);


DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('UQ_StudentSchoolAssociation_NaturalKey')
    ) THEN
        ALTER TABLE dms.edfi_StudentSchoolAssociation ADD CONSTRAINT UQ_StudentSchoolAssociation_NaturalKey
            UNIQUE (StudentUniqueId, SchoolId, EntryDate);
    END IF;
END$$;


-- Foreign Key Constraints

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentSchoolAssociation_EntryGradeLevelDescriptor__052ecde9')
        ) THEN
            ALTER TABLE dms.edfi_StudentSchoolAssociation ADD CONSTRAINT FK_StudentSchoolAssociation_EntryGradeLevelDescriptor__052ecde9
                FOREIGN KEY (EntryGradeLevelDescriptor)
                REFERENCES dms.edfi_descriptor(Id);
        END IF;
END$$;

DO $$
BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM pg_constraint WHERE lower(conname) = lower('FK_StudentSchoolAssociation_Document')
        ) THEN
            ALTER TABLE dms.edfi_StudentSchoolAssociation ADD CONSTRAINT FK_StudentSchoolAssociation_Document
                FOREIGN KEY (Document_Id, Document_PartitionKey)
                REFERENCES dms.Document(Id, DocumentPartitionKey) ON DELETE CASCADE;
        END IF;
END$$;


-- Natural Key Resolution Views

-- Natural Key Resolution View for StudentSchoolAssociation_View
CREATE OR REPLACE VIEW dms.StudentSchoolAssociation_View AS
SELECT
    base.Id,
    base.Document_Id,
    base.Document_PartitionKey,
    base.StudentUniqueId,
    base.SchoolId,
    base.EntryDate,
    base.EntryGradeLevelDescriptor,
    base.ExitWithdrawDate
FROM dms.edfi_StudentSchoolAssociation base;



