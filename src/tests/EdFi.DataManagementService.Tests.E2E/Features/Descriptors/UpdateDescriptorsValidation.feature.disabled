Feature: Resources "Update" Operation validations

    Rule: Descriptors

        Background:
            Given the Data Management Service must receive a token issued by "http://localhost"
              And user is already authorized
              And the system has these descriptors
                  | descriptorValue                                                                            |
                  | uri://ed-fi.org/ContentClassDescriptor#Testing                                             |
                  | uri://ed-fi.org/AddressTypeDescriptor#Physical                                             |
                  | uri://ed-fi.org/StateAbbreviationDescriptor#TX                                             |
                  | uri://tpdm.ed-fi.org/EducationOrganizationCategoryDescriptor#Educator Preparation Provider |
                  | uri://ed-fi.org/GradeLevelDescriptor#Postsecondary                                         |
                  | uri://ed-fi.org/AbsenceEventCategoryDescriptor#Sick Leave                                  |
              And a POST request is made to "/ed-fi/absenceEventCategoryDescriptors" with
                  """
                  {
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave",
                    "effectiveBeginDate": "2024-05-14",
                    "effectiveEndDate": "2024-05-14",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 201 or 200

        @ignore
        Scenario: 01 Put an existing descriptor
            # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave",
                    "effectiveBeginDate": "2024-05-14",
                    "effectiveEndDate": "2024-05-14"
                  }
                  """
             Then it should respond with 204
              And the record can be retrieved with a GET request
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave",
                    "effectiveBeginDate": "2024-05-14",
                    "effectiveEndDate": "2024-05-14"
                  }
                  """

        @ignore
        Scenario: 02 Put an existing descriptor with optional properties removed
            # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 204
              And the record can be retrieved with a GET request
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """

        # Descriptors are not validating properly. DMS-295
        @ignore
        Scenario: 03 Update a descriptor with a string that is too long
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                      "id": "{id}",
                      "codeValue": "Sick LeaveSick LeaveSick LeaveSick LeaveSick LeaveSick LeaveSick LeaveSick Leave",
                      "description": "Sick Leave",
                      "effectiveBeginDate": "2024-05-14",
                      "effectiveEndDate": "2024-05-14",
                      "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                      "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "validationErrors": {
                        "$.codeValue": [
                            "codeValue Value should be at most 50 characters"
                        ]
                    },
                    "errors": [],
                    "detail": "Data validation failed. See 'validationErrors' for details.",
                    "type": "urn:ed-fi:api:bad-request:data",
                    "title": "Data Validation Failed",
                    "status": 400,
                    "correlationId": null
                  }
                  """


        # Ignored because we do not have namespace security for descriptors yet. DMS-81
        @ignore
        Scenario: 04 Put a descriptor using an invalid namespace
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                    {
                        "id": "{id}",
                        "codeValue": "xxxx",
                        "description": "Wrong Value",
                        "namespace": "uri://.org/wrong",
                        "shortDescription": "Wrong Value"
                    }
                  """
             Then it should respond with 403
              And the response body is
                  """
                    {
                        "detail": "Access to the resource could not be authorized. The 'Namespace' value of the resource does not start with any of the caller's associated namespace prefixes ('uri://ed-fi.org', 'uri://gbisd.org', 'uri://tpdm.ed-fi.org').",
                        "type": "urn:ed-fi:api:security:authorization:namespace:access-denied:namespace-mismatch",
                        "title": "Authorization Denied",
                        "status": 403,
                        "correlationId": null
                    }
                  """

        # Descriptors are not validating properly. DMS-295
        @ignore
        Scenario: 05 Update a descriptor with spaces in required fields
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                    {
                        "id": "{id}",
                        "codeValue": "                      ",
                        "description": "                    ",
                        "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                        "shortDescription": "                    "
                    }
                  """
             Then it should respond with 400
              And the response body is
                  """{
                    "validationErrors": {
                        "$.codeValue": [
                            "codeValue cannot contain leading or trailing spaces."
                        ],
                        "$.namespace": [
                            "namespace cannot contain leading or trailing spaces."
                            ],
                        "$.shortDescription": [
                            "shortDescription cannot contain leading or trailing spaces."
                        ]
                    },
                    "errors": [],
                    "detail": "Data validation failed. See 'validationErrors' for details.",
                    "type": "urn:ed-fi:api:bad-request:data",
                    "title": "Data Validation Failed",
                    "status": 400,
                    "correlationId": null
                  }
                  """

        # Descriptors are not validating properly. DMS-295
        @ignore
        Scenario: 06 Update a descruiptor with leading spaces in required fields
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                    {
                        "id": "{id}",
                        "codeValue": "                      a",
                        "description": "                    a",
                        "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                        "shortDescription": "                   a"
                    }
                  """
             Then it should respond with 400
              And the response body is
                  """{
                    "validationErrors": {
                        "$.codeValue": [
                            "codeValue cannot contain leading or trailing spaces."
                        ],
                        "$.namespace": [
                            "namespace cannot contain leading or trailing spaces."
                            ],
                        "$.shortDescription": [
                            "shortDescription cannot contain leading or trailing spaces."
                        ]
                    },
                    "errors": [],
                    "detail": "Data validation failed. See 'validationErrors' for details.",
                    "type": "urn:ed-fi:api:bad-request:data",
                    "title": "Data Validation Failed",
                    "status": 400,
                    "correlationId": null
                  }
                  """

        # Descriptors are not validating the whitespace yet. DMS-295
        @ignore
        Scenario: 07 Update a descriptor with trailing spaces in required fields
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                    {
                        "id": "{id}",
                        "codeValue": "a                      ",
                        "description": "a                    ",
                        "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                        "shortDescription": "a                   "
                    }
                  """
             Then it should respond with 400
              And the response body is
                  """{
                    "validationErrors": {
                        "$.codeValue": [
                            "codeValue cannot contain leading or trailing spaces."
                        ],
                        "$.namespace": [
                            "namespace cannot contain leading or trailing spaces."
                            ],
                        "$.shortDescription": [
                            "shortDescription cannot contain leading or trailing spaces."
                        ]
                    },
                    "errors": [],
                    "detail": "Data validation failed. See 'validationErrors' for details.",
                    "type": "urn:ed-fi:api:bad-request:data",
                    "title": "Data Validation Failed",
                    "status": 400,
                    "correlationId": null
                  }
                  """

        @ignore
        Scenario: 08 Put an existing descriptor with an extra property (overpost)
            # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave",
                    "objectOverpost": {
                        "x": 1
                    }
                  }
                  """
             Then it should respond with 204
              And the record can be retrieved with a GET request
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """

        @ignore
        Scenario: 09 Update a descriptor that does not exist
             # The id value should be replaced with a non existing resource
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/00000000-0000-4000-a000-000000000000" with
                  """
                  {
                    "id": "00000000-0000-4000-a000-000000000000",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 404
              And the response body is
                  """
                  {
                      "detail": "Resource to update was not found",
                      "type": "urn:ed-fi:api:not-found",
                      "title": "Not Found",
                      "status": 404,
                      "correlationId": null,
                      "validationErrors": {},
                      "errors": []
                  }
                  """

        @ignore
        Scenario: 10 Update a descriptor with modification of an identity field
            # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "{id}",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave Edited"
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "detail": "Identifying values for the AbsenceEventCategoryDescriptor resource cannot be changed. Delete and recreate the resource item instead.",
                    "type": "urn:ed-fi:api:bad-request:data-validation-failed:key-change-not-supported",
                    "title": "Key Change Not Supported",
                    "status": 400,
                    "correlationId": null,
                    "validationErrors": {},
                    "errors": []
                    }
                  """

        @ignore
        Scenario: 11  Put an empty request descriptor
             # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "validationErrors": {},
                    "errors": [
                        "A non-empty request body is required."
                    ],
                    "detail": "The request could not be processed. See 'errors' for details.",
                    "type": "urn:ed-fi:api:bad-request",
                    "title": "Bad Request",
                    "status": 400,
                    "correlationId": null
                  }
                  """

        @ignore
        Scenario: 12 Put an empty JSON body
             # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "detail": "Data validation failed. See 'validationErrors' for details.",
                    "type": "urn:ed-fi:api:bad-request:data-validation-failed",
                    "title": "Data Validation Failed",
                    "status": 400,
                    "correlationId": null,
                    "validationErrors": {
                        "$.namespace": [
                        "namespace is required."
                        ],
                        "$.codeValue": [
                        "codeValue is required."
                        ],
                        "$.shortDescription": [
                        "shortDescription is required."
                        ],
                        "$.id": [
                        "id is required."
                        ]
                    },
                    "errors": []
                  }
                  """

        @ignore
        Scenario: 13 Update a DESCRIPTOR with mismatch between URL and id
             # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "00000000-0000-0000-0000-000000000000",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "detail": "The request could not be processed. See 'errors' for details.",
                    "type": "urn:ed-fi:api:bad-request",
                    "title": "Bad Request",
                    "status": 400,
                    "correlationId": null,
                    "validationErrors": {},
                    "errors": [
                        "Request body id must match the id in the url."
                    ]
                  }
                  """

        @ignore
        Scenario: 14 Update a descriptor with a blank id
            # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                   {
                     "detail": "The request could not be processed. See 'errors' for details.",
                     "type": "urn:ed-fi:api:bad-request",
                     "title": "Bad Request",
                     "status": 400,
                     "correlationId": null,
                     "validationErrors": {},
                     "errors": [
                         "Request body id must match the id in the url."
                     ]
                   }
                  """

        @ignore
        Scenario: 15 Update a descriptot with an invalid id format (Descriptor)
             # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "invalid-id",
                    "codeValue": "Sick Leave",
                    "description": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "detail": "The request could not be processed. See 'errors' for details.",
                    "type": "urn:ed-fi:api:bad-request",
                    "title": "Bad Request",
                    "status": 400,
                    "correlationId": null,
                    "validationErrors": {},
                    "errors": [
                        "Request body id must match the id in the url."
                    ]
                  }
                  """
        # DMS-297
        # Not sure yet what the expected response should be. Depends on what the
        # JSON schema can do.
        @ignore
        Scenario: 16 Update a descriptor with duplicate properties
             # The id value should be replaced with the resource created in the Background section
             When a PUT request is made to "/ed-fi/absenceEventCategoryDescriptors/{id}" with
                  """
                  {
                    "id": "invalid-id",
                    "codeValue": "Sick Leave",
                    "shortDescription": "Sick Leave Edited",
                    "namespace": "uri://ed-fi.org/AbsenceEventCategoryDescriptor",
                    "shortDescription": "Sick Leave"
                  }
                  """
             Then it should respond with 400
              And the response body is
                  """
                  {
                    "detail": "The request could not be processed. See 'errors' for details.",
                    "type": "urn:ed-fi:api:bad-request",
                    "title": "Bad Request",
                    "status": 400,
                    "correlationId": null,
                    "validationErrors": {
                       "$.shortDescription": [
                         "shortDescription value occurs twice"
                       ]
                     },
                     "errors": []
                  }
                  """

        @ignore
        Scenario: 17 Ensure clients cannot update a descriptor omitting any of the required values
             When a POST request is made to "/ed-fi/disabilityDescriptors" with
                  """
                  {
                      "namespace": "uri://ed-fi.org/DisabilityDescriptor",
                      "shortDescription": "Deaf-Blindness",
                      "description": "Deaf-Blindness"
                  }
                  """
             Then it should respond with 409
              And the response body is
                  """
                  {
                      "detail": "Data validation failed. See 'validationErrors' for details.",
                      "type": "urn:ed-fi:api:bad-request:data-validation-failed",
                      "title": "Data Validation Failed",
                      "status": 409,
                      "correlationId": null,
                      "validationErrors": {
                          "$.namespace": [
                              "CodeValue is required."
                          ]
                      }
                  }
                  """

        @ignore
        Scenario: 18 Ensure clients can update a descriptor that is not being used by any resource
            Given the system has this "disabilityDescriptors" descriptor
                  | codeValue                              | namespace                            | shortDescription                       |
                  | Visual Impairment, including Blindness | uri://ed-fi.org/DisabilityDescriptor | Visual Impairment, including Blindness |
             When a PUT request is made to "/ed-fi/disabilityDescriptors/{id}" with
                  """
                  {
                      "codeValue": "Visual Impairment, including Blindness",
                      "description": "Visual Impairment, including Blindness",
                      "namespace": "uri://ed-fi.org/DisabilityDescriptor",
                      "shortDescription": "Visual Impairment, including Blindness EdFi Test"
                  }
                  """
             Then it should respond with 204

        @ignore
        Scenario: 19 Ensure clients cannot update a descriptor changing identifying values
            Given the system has this "disabilityDescriptors" descriptor
                  | codeValue                              | namespace                            | shortDescription                       |
                  | Visual Impairment, including Blindness | uri://ed-fi.org/DisabilityDescriptor | Visual Impairment, including Blindness |
             When a PUT request is made to "/ed-fi/disabilityDescriptors/{id}" with
                  """
                  {
                      "codeValue": "Visual Impairment, including Blindness Ed-Fi Test",
                      "description": "Visual Impairment, including Blindness",
                      "namespace": "uri://ed-fi.org/DisabilityDescriptorEd-FiTest",
                      "shortDescription": "Visual Impairment, including Blindness"
                  }
                  """
             Then it should respond with 409
              And the response body is
                  """
                  {
                      "detail": "Identifying values for the DisabilityDescriptor data cannot be changed. Delete and recreate the item instead.",
                      "type": "urn:ed-fi:api:bad-request:data-validation-failed:key-change-not-supported",
                      "title": "Key Change Not Supported",
                      "status": 400,
                      "correlationId": null
                  }
                  """

